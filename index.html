<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="Padtec.png" />
    <title>COPE|PADTEC - Painel de Operações</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JE7KXLXQEL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JE7KXLXQEL');
    </script>
    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');

        :root {
            --padtec-orange: #F37021;
            --padtec-black: #1A1A1A;
            --vivo-orange: #FF8C00;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #111827;
            transition: background-color 0.3s ease;
        }

        .volumetria-mode {
            background-color: var(--padtec-black);
            background-image: 
                linear-gradient(135deg, #1a1a1a 25%, transparent 25%), 
                linear-gradient(225deg, #1a1a1a 25%, transparent 25%), 
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%), 
                linear-gradient(315deg, #1a1a1a 25%, #262626 25%);
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            background-size: 20px 20px;
            background-attachment: fixed;
        }

        .hover-lift-card {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid transparent;
        }
        .hover-lift-card:hover {
            transform: translateY(-8px);
            border-color: var(--vivo-orange);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            background-color: #ffffff;
        }

        .btn-depth {
            background: var(--vivo-orange);
            border: none;
            padding: 16px 32px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 0 #cc7000, 0 12px 20px rgba(0,0,0,0.15);
            position: relative;
            cursor: pointer;
            width: 100%;
        }
        .btn-depth:hover { 
            transform: translateY(-4px); 
            background-color: #ff9d26;
            box-shadow: 0 8px 0 #cc7000, 0 15px 25px rgba(0,0,0,0.2); 
        }
        .btn-depth:active { transform: translateY(2px); box-shadow: 0 2px 0 #cc7000; }

        .btn-action { transition: all 0.3s ease; }
        .btn-action:hover { transform: translateY(-3px); filter: brightness(1.1); }

        .table-container {
            max-height: 550px;
            overflow: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background: #000; color: white; z-index: 10; padding: 12px 16px; text-align: left; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; font-size: 0.8rem; }
        .modified-cell { background-color: #fef3c7; color: #92400e; font-weight: 600; }
        .blank-row { background-color: #e5e7eb !important; height: 20px; }

        .col-historico {
            max-width: 450px;
            min-width: 300px;
            white-space: normal !important;
            word-break: break-word;
            line-height: 1.4;
            text-transform: uppercase;
            color: #374151;
            font-weight: 600;
        }

        .letterhead-container {
            background: #ffffff;
            border-top: 8px solid var(--padtec-orange);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            color: #1a1a1a;
            max-width: 1280px;
            margin: 0 auto;
        }
        .chart-container { position: relative; height: 280px; width: 100%; }
        
        .kpi-card { 
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid #f1f5f9; 
            background: #ffffff; 
        }
        .kpi-card:hover { 
            transform: translateY(-8px); 
            border-color: var(--padtec-orange); 
            box-shadow: 0 15px 30px rgba(243, 112, 33, 0.1);
        }

        .number-badge { background-color: rgba(243, 112, 33, 0.12); padding: 0.4rem 1.2rem; border-radius: 1rem; display: inline-block; min-width: 70px; cursor: pointer; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--vivo-orange); border-radius: 10px; }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px;
            border-radius: 50%; border-left-color: var(--vivo-orange); animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .nav-btn {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .nav-btn:hover { 
            background-color: var(--vivo-orange); 
            color: white; 
            border-color: var(--vivo-orange);
            transform: translateY(-3px);
        }

        .btn-export-es {
            background-color: var(--padtec-orange);
            color: white;
            font-size: 0.6rem;
            font-weight: 900;
            padding: 4px 10px;
            border-radius: 6px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .total-geral-box {
            border: 2px solid #3b82f6;
            background-color: #eff6ff;
            padding: 10px;
            border-radius: 12px;
            min-width: 100px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }
        .total-geral-box:hover {
            background-color: #dbeafe;
            transform: scale(1.05);
        }

        .daily-item {
            font-size: 0.75rem;
            font-weight: 900;
            color: #991b1b;
            padding: 6px 12px;
            background: #ffffff;
            border: 1px solid #fecaca;
            border-radius: 6px;
            display: block;
            width: fit-content;
        }

        .analista-item { cursor: pointer; user-select: none; }
        .analista-item:hover { background-color: #fffaf0; }
        .detalhes-badge { font-size: 0.6rem; background-color: #f3f4f6; color: #9ca3af; padding: 2px 6px; border-radius: 4px; font-weight: 800; }
        .expand-toggle { cursor: pointer; transition: all 0.3s ease; padding: 4px 8px; border-radius: 6px; }

        .btn-view-toggle {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.6rem;
            font-weight: 900;
            text-transform: uppercase;
            transition: all 0.2s ease;
        }
        .btn-view-toggle:hover {
            background-color: #ef4444;
            color: white;
        }
        .btn-view-toggle.active {
            background-color: #ef4444;
            color: white;
        }

        .pdf-export-mode { padding: 20px !important; margin: 0 !important; box-shadow: none !important; border: none !important; }
        .pdf-export-mode .no-print { display: none !important; }
        
        /* Ajustes de Gráficos para PDF */
        .pdf-export-mode .chart-container { height: 200px !important; width: 100% !important; page-break-inside: avoid; }
        /* Altura reduzida em ~15% (260px -> 220px) e ajustes de padding/margin para evitar overflow */
        .pdf-export-mode .pdf-chart-height { height: 220px !important; page-break-inside: avoid; padding: 12px !important; overflow: hidden; }
        .pdf-export-mode .pdf-chart-height .mb-8 { margin-bottom: 8px !important; }
        .pdf-export-mode .pdf-chart-height-small { height: 140px !important; page-break-inside: avoid; }
        .pdf-export-mode canvas { max-width: 100% !important; max-height: 100% !important; object-fit: contain; }
    </style>
</head>
<body class="min-h-screen flex flex-col" id="main-body">

    <!-- Modal Detalhes de Pendências e Tags (Volumetria) -->
    <div id="detailsModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[85vh] overflow-hidden flex flex-col transform transition-transform scale-95 duration-300" id="modalBox">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 id="modalAnalista" class="text-2xl font-black text-slate-800 uppercase tracking-tighter leading-none mb-1">Causa</h3>
                    <p id="modalSubTitle" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Detalhamento de Comentários e Pendências por Causa</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btnExtrairModal" onclick="exportModalDataToExcel()" class="hidden bg-green-600 text-white px-4 py-2 rounded-lg font-black text-[10px] uppercase hover:bg-green-700 transition shadow-lg">Extrair XLS</button>
                    <button onclick="closeModal()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-200 transition-colors">
                        <i class="fas fa-times text-slate-500 text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="modalContent" class="p-6 overflow-x-auto overflow-y-auto custom-scrollbar flex-grow bg-white"></div>
            <div class="p-4 bg-slate-50 border-t flex justify-end">
                <button onclick="closeModal()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-black text-xs uppercase hover:bg-black transition shadow-lg">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmação Importação Ligações -->
    <div id="confirmImportModal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col transform transition-transform scale-95 duration-300" id="confirmModalBox">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-file-import text-blue-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 uppercase mb-2">Importar Ligações?</h3>
                <p class="text-sm text-slate-500 font-bold">Deseja importar o arquivo de ligações agora?</p>
            </div>
            <div class="p-4 bg-slate-50 border-t flex gap-3 justify-center">
                <button onclick="closeConfirmModal()" class="bg-slate-200 text-slate-600 px-6 py-2 rounded-lg font-black text-xs uppercase hover:bg-slate-300 transition">Não Importar</button>
                <button onclick="triggerLigacoesImport()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-black text-xs uppercase hover:bg-blue-700 transition shadow-lg">Importar</button>
            </div>
        </div>
    </div>

    <!-- Botão Global de Voltar -->
    <div class="fixed top-4 left-4 z-50 no-print">
        <a href="https://jefferson-silva-padtec.github.io/COPE/" class="inline-flex items-center gap-2 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-lg btn-action">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Voltar
        </a>
    </div>

    <!-- Botão Admin -->
    <div class="fixed top-4 right-4 z-50 no-print">
        <button id="btnAdmin" ondblclick="toggleAdminMode()" class="bg-gray-800 text-white px-4 py-2 rounded-lg font-bold text-xs uppercase shadow-lg hover:bg-gray-700 transition-colors">Admin</button>
    </div>

    <!-- PÁGINA 1: OPERAÇÕES -->
    <section id="page-operacoes" class="flex-grow flex flex-col">
        <header class="bg-black text-white py-6 shadow-xl border-b-4 border-orange-500">
            <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight uppercase leading-tight">Painel de Operações <span class="text-orange-500">COPE</span></h1>
                    <p class="text-gray-400 mt-1 text-xs uppercase tracking-widest font-semibold">Notificações e Causa Comum</p>
                </div>
                <nav class="flex items-center gap-6">
                    <button onclick="switchPage('volumetria')" class="nav-btn">Ir para Volumetria →</button>
                </nav>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 py-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 flex flex-col items-center hover-lift-card">
                    <div class="mb-6 text-center">
                        <div class="w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800 uppercase tracking-tight">Limpador Notificação TA</h2>
                        <p class="text-gray-500 text-xs mt-1 italic">Arquivo (Parcial.xls) do SIGO.</p>
                    </div>
                    <input type="file" id="fileInputTA" accept=".xls,.xlsx,.csv" class="hidden">
                    <button onclick="document.getElementById('fileInputTA').click()" class="btn-depth">Selecionar Arquivo</button>
                    <div id="loadingTA" class="hidden mt-6 flex flex-col items-center"><div class="loading-spinner"></div></div>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 flex flex-col items-center hover-lift-card">
                    <div class="mb-6 text-center">
                        <div class="w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 014-4h1m-5 10v-5a2 2 0 012-2h3m2 4l2 2m0 0l2-2m-2 2v-5a2 2 0 012-2h3"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800 uppercase tracking-tight">Tickets Causa Comum</h2>
                        <p class="text-gray-500 text-xs mt-1 italic">Arquivo (ARM-Splitter.xls) do SIGO.</p>
                    </div>
                    <input type="file" id="fileInputCausa" accept=".xls,.xlsx,.csv" class="hidden">
                    <button onclick="document.getElementById('fileInputCausa').click()" class="btn-depth">Selecionar Arquivo</button>
                    <div id="loadingCausa" class="hidden mt-6 flex flex-col items-center"><div class="loading-spinner"></div></div>
                </div>
            </div>

            <!-- Painéis de Resultados Operações -->
            <div id="results-ta" class="hidden w-full mb-12">
                <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-t-xl shadow border-l-8 border-orange-500">
                    <div><h3 class="text-lg font-bold text-gray-800 uppercase leading-tight">Resultado: ARQUIVO LIMPO</h3><p id="stats-ta" class="text-gray-500 text-xs"></p></div>
                    <div class="flex gap-2">
                        <button onclick="clearTA()" class="bg-white border border-gray-300 text-gray-600 px-5 py-2 rounded-lg text-xs font-bold transition btn-action">LIMPAR</button>
                        <button onclick="downloadTA()" class="bg-orange-500 text-white px-5 py-2 rounded-lg text-xs font-bold transition shadow btn-action uppercase">Baixar Arquivo Limpo</button>
                    </div>
                </div>
                <div class="table-container shadow-xl rounded-b-xl"><table id="tableTA"><thead id="headTA"></thead><tbody id="bodyTA"></tbody></table></div>
            </div>

            <div id="results-causa" class="hidden w-full mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-t-xl shadow border-l-8 border-orange-500">
                    <div><h3 class="text-lg font-bold text-gray-800 uppercase leading-tight">Resultado: Causa Comum</h3><p id="stats-causa" class="text-gray-500 text-xs"></p></div>
                    <div class="flex gap-2">
                        <button onclick="clearCausa()" class="bg-white border border-gray-300 text-gray-600 px-4 py-2 rounded-lg text-xs font-bold transition btn-action">LIMPAR</button>
                        <button onclick="downloadCausaExcel()" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow btn-action uppercase">Exportar XLS</button>
                    </div>
                </div>
                <div class="table-container shadow-xl rounded-b-xl">
                    <table id="tableCausa">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Splitter</th>
                                <th>CI</th>
                                <th>Sub Cat</th>
                                <th>Ref</th>
                                <th>Tag Ori</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="bodyCausa"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </section>

    <!-- PÁGINA 2: VOLUMETRIA (DASHBOARD) -->
    <section id="page-volumetria" class="hidden flex-grow py-8 md:py-12">
        <div id="dashboard-content" class="letterhead-container space-y-8 p-10 rounded-sm">
            <div class="flex flex-col md:flex-row justify-between items-start border-b-2 border-slate-100 pb-8 gap-6">
                <div class="flex items-center gap-5">
                    <div class="w-2.5 h-14 bg-orange-50 rounded-full"></div>
                    <div>
                        <h1 class="text-5xl font-black text-slate-900 tracking-tighter uppercase leading-none">PRODUÇÃO COPE</h1>
                        <p class="text-slate-400 font-bold mt-2 tracking-widest text-xs uppercase font-black">Relatório de Produtividade | PADTEC</p>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-3">
                    <div class="flex gap-3 no-print">
                        <button onclick="switchPage('operacoes')" class="bg-slate-800 text-white px-6 py-3 rounded-lg font-black text-[10px] hover:bg-black transition shadow-xl btn-action">← VOLTAR PARA OPERAÇÕES</button>
                        <label class="cursor-pointer bg-orange-500 text-white px-6 py-3 rounded-lg font-black transition flex items-center gap-2 shadow-xl text-[10px] hover:bg-orange-600 btn-action">IMPORTAR DADOS<input type="file" id="fileInputVol" class="hidden" accept=".xls,.xlsx,.csv"></label>
                        <button onclick="downloadPDF()" class="bg-black text-white px-6 py-3 rounded-lg font-black transition shadow-xl text-[10px] btn-action">EXPORTAR PDF</button>
                    </div>
                    <div class="flex items-center gap-2 bg-slate-100/10 px-3 py-2 rounded-lg border border-slate-100/20">
                        <label for="dateFilter" class="text-[10px] font-black text-slate-300 uppercase tracking-widest"><i class="far fa-calendar-alt mr-2"></i>Data Ref:</label>
                        <select id="dateFilter" onchange="filterByDate()" class="bg-transparent text-orange-500 text-[10px] font-black uppercase focus:outline-none cursor-pointer border-b border-orange-500/50 pb-0.5 hover:border-orange-500 transition-colors"><option value="all" class="text-slate-800">Geral</option></select>
                    </div>
                    <div id="monthFilterContainer" class="flex gap-1 mt-1 justify-end flex-wrap max-w-[300px]"></div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-8">
                <div class="kpi-card md:col-span-2 p-8 rounded-2xl flex flex-col justify-center items-center relative text-center shadow-sm hover-lift-card">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 font-black">Total de tickets verificados</p>
                    <div class="number-badge" ondblclick="openKpiModal('total')"><h2 id="kpi-total" class="text-[66px] font-black text-slate-800 leading-none">0</h2></div>
                    <div id="kpi-breakdown" class="hidden flex gap-6 mt-8 w-full justify-center">
                        <div class="text-center cursor-pointer" ondblclick="openKpiModal('agregadores')"><p id="stat-agregadores-val" class="text-[33px] font-black text-slate-700 leading-none">0</p><p class="text-[9px] font-bold text-slate-400 uppercase mt-2 font-black">Agregadores</p></div>
                        <div class="h-8 w-px bg-slate-200"></div>
                        <div class="text-center cursor-pointer" ondblclick="openKpiModal('agregado')"><p id="stat-agregado-val" class="text-[33px] font-black text-slate-700 leading-none">0</p><p class="text-[9px] font-bold text-slate-400 uppercase mt-2 font-black">Agregado</p></div>
                    </div>
                    <button ondblclick="openAcoesModal()" class="absolute bottom-3 right-4 text-[9px] font-black text-slate-300 hover:text-orange-500 transition-colors uppercase tracking-widest border border-transparent hover:border-orange-500 rounded px-2 py-1">AÇÕES</button>
                </div>
                
                <div class="kpi-card md:col-span-3 p-8 rounded-2xl flex flex-col items-stretch bg-slate-50/20 shadow-sm border-l-4 border-l-orange-500 overflow-hidden hover-lift-card relative">
                    <button onclick="downloadExcelES()" class="absolute top-4 right-14 btn-export-es no-print font-black">EXPORTAR DADOS ES</button>
                    <div class="flex flex-col gap-3 flex-1">
                        <div class="flex items-end justify-between border-b-2 border-slate-100/50 pb-2">
                            <div><p class="text-[10px] font-black text-red-700 uppercase tracking-[0.2em] mb-2 leading-tight font-black">TOTAL ESPÍRITO SANTO</p><div class="number-badge" ondblclick="openKpiModal('es')"><h2 id="kpi-es" class="text-[46px] font-black text-slate-800 leading-none">0</h2></div></div>
                        </div>
                        <div class="flex flex-col md:flex-row gap-10 items-start">
                            <div class="flex-1 w-full min-w-0"><p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2 font-black"><span class="w-2 h-2 bg-orange-500 rounded-sm"></span>CIDADES EM FOCO</p><div id="top-cities-es" class="flex flex-col gap-2 h-[125px] overflow-y-auto pr-2 custom-scrollbar"><p class="text-slate-300 text-xs italic py-2 uppercase font-black">Aguardando...</p></div></div>
                            <div class="flex-1 w-full min-w-0 md:pl-10 md:border-l-2 md:border-slate-100"><p class="text-[9px] font-black text-slate-700 uppercase tracking-widest mb-3 flex items-center gap-2 font-black"><span class="w-2 h-2 bg-slate-800 rounded-sm"></span>PRINCIPAIS CAUSAS ES</p><div id="causas-es-list-container" class="space-y-1.5 h-[105px] overflow-y-auto pr-2 custom-scrollbar"><p class="text-slate-300 text-[10px] italic py-2 uppercase font-black">Aguardando...</p></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Volume de Pendências e Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- COLUNA ESQUERDA: VOLUME E PROGRESSÃO -->
                <div class="space-y-8 flex flex-col">
                    <div class="p-8 border-2 border-red-200 rounded-2xl bg-slate-50 shadow-sm hover-lift-card flex flex-col h-[500px]">
                        <div class="flex justify-between items-start mb-6 border-b border-red-100 pb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-1.5 h-5 bg-red-600"></div>
                                <div class="bg-red-100 border border-red-200 px-3 py-1 rounded-lg">
                                    <h3 class="font-black text-red-900 uppercase text-xs tracking-[0.2em]">VOLUME DE PENDENCIAS</h3>
                                </div>
                                <button id="pendenciaViewControls" onclick="cyclePendenciaView()" class="btn-view-toggle hidden min-w-[80px]">Turnos</button>
                            </div>
                            <div class="flex flex-col items-end cursor-pointer" ondblclick="openTotalPendenciasModal()">
                                <p class="text-[10px] font-black text-slate-900 uppercase tracking-[0.2em] mb-2 leading-tight">Total Geral</p>
                                <div class="border-2 border-slate-800 rounded-xl px-3 py-1 min-w-[60px] text-center"><p id="total-pendencias-counter" class="text-2xl font-black text-slate-800 leading-none">0</p></div>
                            </div>
                        </div>
                        <div id="analistas-list-container" class="space-y-4 flex-grow overflow-y-auto pr-3 custom-scrollbar">
                            <div id="main-pendencias-list" class="space-y-3">
                                 <p class="text-center text-red-300 text-xs italic py-24 uppercase tracking-widest font-black">Aguardando importação...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- COLUNA DIREITA: TAGS -->
                <div class="p-8 border border-slate-100 rounded-2xl bg-white shadow-sm hover-lift-card flex flex-col h-[500px]">
                    <div class="flex items-center gap-3 mb-8 border-b border-slate-50 pb-4 font-black"><div class="w-1.5 h-5 bg-orange-500"></div><h3 class="font-black text-slate-800 uppercase text-xs tracking-[0.2em]">Distribuição de Tags</h3></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 h-[400px]">
                        <div class="bg-slate-50 border-2 border-slate-900 rounded-xl p-4 flex flex-col justify-center gap-4 shadow-md overflow-hidden hover:bg-slate-100 transition-all font-black">
                            <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] text-center font-black">Operacionais</h4>
                            <div class="flex justify-around items-center">
                                <div class="text-center">
                                    <div class="number-badge mb-2" ondblclick="openTagDetailsModal('ADM COPE')"><p id="tag-adm-val" class="text-[26px] font-black text-slate-800">0</p></div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase">ADM COPE</p>
                                </div>
                                <div class="text-center">
                                    <div class="number-badge mb-2" ondblclick="openTagDetailsModal('DESAGREGADO')"><p id="tag-desag-val" class="text-[26px] font-black text-slate-800">0</p></div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase">DESAGREGADO</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-orange-50 border-2 border-orange-500 rounded-xl p-4 flex flex-col justify-center gap-4 shadow-md overflow-hidden hover:bg-orange-100 transition-all font-black">
                            <h4 class="text-[10px] font-black text-orange-600 uppercase tracking-[0.2em] text-center font-black">Salas de Crise</h4>
                            <div class="flex justify-around items-start">
                                <div class="text-center">
                                    <div class="number-badge mb-2" ondblclick="openTagDetailsModal('SALAS COPE')"><p id="tag-sala-cope-val" class="text-[26px] font-black text-orange-700">0</p></div>
                                    <p class="text-[10px] font-black text-orange-400 uppercase">Salas COPE</p>
                                    <div class="mt-1 text-[8px] font-black text-orange-800 flex flex-col">
                                        <span>AGG: <span id="sc-agg-val">0</span></span>
                                        <span>B2B: <span id="sc-b2b-val">0</span></span>
                                        <span>PON LOSS: <span id="sc-pon-val">0</span></span>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="number-badge mb-2" ondblclick="openTagDetailsModal('SALAS NOC')"><p id="tag-sala-noc-val" class="text-[26px] font-black text-orange-700">0</p></div>
                                    <p class="text-[10px] font-black text-orange-400 uppercase">Salas NOC</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progressão de Pendências (Full Width) -->
            <div class="w-full mb-8">
                <div class="p-8 border-2 border-red-200 rounded-2xl bg-red-50 shadow-sm hover-lift-card h-[400px] flex flex-col pdf-chart-height">
                    <div class="flex justify-between items-center mb-8 border-b border-red-100 pb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-1.5 h-5 bg-red-600"></div>
                            <h3 class="font-black text-red-900 uppercase text-xs tracking-[0.2em]">Progressão de Pendências</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="date" id="pendStart" onchange="renderPendenciasChart()" class="bg-white border border-red-200 text-red-900 text-[10px] font-bold rounded px-2 py-1 focus:outline-none focus:border-red-500 uppercase">
                            <span class="text-red-300 text-[10px] font-black">ATÉ</span>
                            <input type="date" id="pendEnd" onchange="renderPendenciasChart()" class="bg-white border border-red-200 text-red-900 text-[10px] font-bold rounded px-2 py-1 focus:outline-none focus:border-red-500 uppercase">
                        </div>
                    </div>
                    <div class="flex-grow flex flex-col overflow-hidden">
                        <div class="flex-grow min-h-0">
                            <canvas id="pendenciasProgressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LIGAÇÕES COPE -->
            <div class="w-full mb-8">
                <div class="p-8 border-2 border-blue-200 rounded-2xl bg-blue-50 shadow-sm hover-lift-card flex flex-col">
                    <div class="flex justify-between items-center mb-6 border-b border-blue-100 pb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-1.5 h-5 bg-blue-600"></div>
                            <h3 class="font-black text-blue-900 uppercase text-xs tracking-[0.2em]">LIGAÇÕES COPE</h3>
                        </div>
                        <label class="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg font-black text-[10px] uppercase hover:bg-blue-700 transition shadow-lg flex items-center gap-2 no-print">
                            IMPORTAR CSV/XLS
                            <input type="file" id="fileInputLigacoesCope" class="hidden" accept=".csv,.xls,.xlsx">
                        </label>
                    </div>
                    
                    <div id="ligacoes-content" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 text-center">
                                <p class="text-[12px] font-black text-slate-400 uppercase">Total Ligações</p>
                                <p id="total-ligacoes" class="text-3xl font-black text-blue-800 leading-none mb-2">0</p>
                                <div class="flex justify-center gap-6 items-center border-t border-blue-100 pt-2 mt-1">
                                    <div class="text-center">
                                        <p class="text-[8px] font-black text-red-600 uppercase">Rejeitadas</p>
                                        <p id="total-rejeitadas" class="text-sm font-black text-red-400 leading-none">0</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[8px] font-black text-green-600 uppercase">Sucesso</p>
                                        <p id="total-sucesso" class="text-sm font-black text-green-400 leading-none">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 text-center">
                                <p class="text-[10px] font-black text-slate-400 uppercase">Tempo Total</p>
                                <p id="total-tempo-ligacoes" class="text-3xl font-black text-blue-800">00:00:00</p>
                            </div>
                             <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 text-center">
                                <p class="text-[10px] font-black text-slate-400 uppercase">Dias Analisados</p>
                                <p id="total-dias-ligacoes" class="text-3xl font-black text-blue-800">0</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100"><h4 class="text-[10px] font-black text-slate-500 uppercase mb-3 border-b pb-2">Ligaçõoes por Turno</h4><div id="lista-colaboradores-ligacoes" class="flex gap-2 h-[170px]"></div></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100">
                                <h4 class="text-[10px] font-black text-slate-500 uppercase mb-3 border-b pb-2">Progressão Diária</h4>
                                <div class="h-[200px] relative pdf-chart-height-small">
                                    <canvas id="ligacoesCopeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="ligacoes-placeholder" class="text-center py-10 text-blue-300 font-black uppercase text-xs">Aguardando importação de arquivo...</div>
                </div>
            </div>

            <!-- Gráficos de Base -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div class="p-8 border border-slate-100 rounded-2xl bg-white shadow-sm hover-lift-card">
                    <div class="flex items-center gap-3 mb-8 border-b border-slate-50 pb-4 font-black"><div class="w-1.5 h-5 bg-orange-500"></div><h3 class="font-black text-slate-800 uppercase text-xs tracking-[0.2em]">Principais Causas Gerais</h3></div>
                    <div id="causas-list-container" class="space-y-4 h-[300px] overflow-y-auto pr-3 custom-scrollbar"><p class="text-center text-slate-300 text-xs italic py-24 uppercase font-black">Aguardando...</p></div>
                </div>
                <div class="p-8 border border-slate-100 rounded-2xl bg-white shadow-sm hover-lift-card"><h3 class="font-black text-slate-800 mb-8 text-center uppercase text-xs tracking-[0.2em] font-black">Top 5 Regiões</h3><div class="chart-container"><canvas id="regioesChart"></canvas></div></div>
            </div>

            <div class="grid grid-cols-1 gap-10">
                 <div class="p-8 border border-slate-100 rounded-2xl bg-white shadow-sm hover-lift-card h-[400px] flex flex-col pdf-chart-height">
                    <h3 class="font-black text-slate-800 mb-8 text-center uppercase text-xs tracking-[0.2em] font-black">Progressão Diária de TTK's</h3>
                    <div class="flex-grow min-h-0"><canvas id="timelineChart"></canvas></div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-gray-900 text-gray-500 py-6 text-center text-xs no-print">
        <div class="container mx-auto px-4 uppercase font-bold tracking-widest">&copy; 2026 - Central de Ferramentas COPE PADTEC | Painel Integrado</div>
    </footer>

    <script>
        // --- VARIÁVEIS GLOBAIS ---
        let processedTA = [], headersTA = [], processedCausa = [];
        let volDataES = [], volSummaryES = {}; 
        let isAdminMode = false;
        let defaultFilesLoaded = false;
        let currentCausaPendenciaDetails = {}; 
        let currentAnalistaPendenciaDetails = {};
        let tagDetailsLists = { 'ADM COPE': [], 'DESAGREGADO': [], 'SALAS COPE': [], 'SALAS NOC': [] };
        let kpiData = { total: [], agregadores: [], agregado: [] };
        let masterPendenciasList = []; 
        let pendenciasViewMode = 'turnos'; 
        let charts = {};
        const CIDADES_ES_ALVO = ["VIANA", "CACHOEIRO DE ITAPEMERIM", "GUARAPARI", "SAO MATEUS", "SANTA MARIA DE JETIBA", "ARACRUZ"];
        const MONTH_NAMES = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];
        const DATE_STAMP_REGEX = /\d{2}-\d{2}-\d{4}\s\d{2}:\d{2}:\d{2}/;
const ANALISTAS_ALVO = ["LUAN VIEIRA LOPES", "JULIANA COSTA PEREIRA DA SILVA", "BRUNO MELLO DA SILVA", "TAMIRIS AVELINA GONÇALVES", "RANDU MATOS MENEZES", "ELVIS MIRANDA", "CAIO HENRIQUE MOREIRA", "GABRIEL NOGUEIRA DE SOUZA", "NOC/JEFFERSON", "NOC/JOSEYLSON", "NOC/EDMAR"];        const TARGET_TEXT_TA = "Notificação de TA para Vivo realizada com sucesso.";
        const SHIFT_DEFINITIONS = {
            "T1": { time: "06H15 ÁS 15H15", members: ["TAMIRIS", "BRUNO", "JULIANA", "JOSEYLSON"] },
            "T2": { time: "15H00 ÁS 23H43", members: ["ELVIS", "RANDU", "LUAN", "JEFFERSON"] },
            "T3": { time: "23H30 ÁS 06h30", members: ["CAIO", "EDMAR", "GABRIEL"] }
        };
        const CIDADES_ALCIDES = [
            "Arapiraca", "Arraial D'Ajuda", "Barreiras", "Eunapolis", "Guanambi", "Ilheus", "Itabuna", "Jequie", "Lagarto", 
            "Luis Eduardo Magalhaes", "Porto Seguro", "Santo Antonio de Jesus", "Teixeira de Freitas", "Trancoso", "Vitoria da Conquista", 
            "Crato", "Juazeiro do Norte", "Sobral", "Cabedelo", "Patos", "Petrolina", "Garanhuns", "Parnaiba", "Picos", "Teresina", "Mossoro", "Parnamirim"
        ];
        const CIDADES_ANDERSON = [
            "Cachoeiro de Itapemirim", "Guarapari", "Santa Maria de Jetiba", "Viana", "Aracruz", "Sao Mateus", "Araruama", "Armacao dos Buzios", "Cabo Frio", "Iguaba Grande", 
            "Itaperuna", "Petropolis", "Rio Bonito", "Rio das Ostras", "Angra dos Reis", "Barra Mansa", "Barra do Pirai", "Mangaratiba", "Nova Friburgo", "Paraty", "Resende", 
            "Volta Redonda", "Sao Pedro da Aldeia", "Teresopolis", "Tres Rios", "Valenca"
        ];
        const CIDADES_CARLOS = [
            "Uberlandia", "Uberaba", "Ibirite", "Divinopolis", "Ribeirao das Neves", "Sete Lagoas", "Santa Luzia", "Tres Coracoes", "Timoteo", "Tres Pontas", "Varginha", 
            "Pocos de Caldas", "Pouso Alegre", "Nova Lima", "Concordia", "Capinzal", "Fraiburgo", "Garopaba", "Imbituba", "Mafra", "Navegantes", "Pomerode", "Rio do Sul", "Sao Bento do Sul"
        ];
        const CIDADES_JOSE = [
            "Manaus", "Macapa", "Acailandia", "Balsas", "Imperatriz", "Paco do Lumiar", "Santa Ines", "Sao Jose de Ribamar", "Sao Luis", "Altamira", "Belem", "Castanhal", 
            "Canaa dos Carajas", "Capanema", "Paragominas", "Parauapebas", "Redencao", "Tucurui"
        ];
        const CIDADES_THIAGO = [
            "Jaragua", "Jatai", "Mineiros", "Caldas Novas", "Catalao", "Itumbiara", "Morrinhos", "Formosa", "Itaberai", "Inhumas", "Tres Lagoas", "Campo Verde", "Primavera do Leste", 
            "Tangara da Serra", "Lucas do Rio Verde", "Nova Mutum", "Sorriso", "Sinop", "Ji-Parana", "Carlos Barbosa", "Dois Irmaos", "Erechim", "Flores da Cunha", "Garibaldi", "Ivoti", 
            "Capao da Canoa", "Nova Petropolis", "Osorio", "Sao Marcos", "Torres", "Taquara", "Tramandai", "Veranopolis", "Xangri-la", "Santa Rosa", "Santo Angelo", "Tres de Maio", 
            "Alegrete", "Bage", "Camaqua", "Cachoeira do Sul", "Canela", "Carazinho", "Charqueadas", "Estrela", "Gramado", "Igrejinha", "Ijui", "Lajeado", "Lagoa Vermelha", 
            "Palmeira das Missoes", "Sant'Ana do Livramento", "Sarandi", "Teutonia", "Uruguaiana", "Vacaria", "Venancio Aires", "Araguaina", "Palmas"
        ];
        const EPS_R2 = ["Arapiraca", "Arraial D'Ajuda", "Barreiras", "Eunapolis", "Guanambi", "Ilheus", "Itabuna", "Jequie", "Lagarto", "Luis Eduardo Magalhaes", "Porto Seguro", "Santo Antonio de Jesus", "Teixeira de Freitas", "Trancoso", "Vitoria da Conquista", "Crato", "Juazeiro do Norte", "Sobral", "Petrolina", "Parnaiba"];
        const EPS_ONDACOM = ["Uberlandia", "Uberaba", "Ibirite", "Manaus", "Macapa", "Acailandia", "Balsas", "Imperatriz", "Paco do Lumiar", "Santa Ines", "Sao Jose de Ribamar", "Sao Luis", "Altamira", "Belem", "Castanhal", "Canaa dos Carajas", "Capanema", "Paragominas", "Parauapebas", "Redencao", "Tucurui", "Jaragua", "Jatai", "Mineiros", "Caldas Novas", "Catalao", "Itumbiara", "Morrinhos", "Tres Lagoas", "Campo Verde", "Primavera do Leste", "Tangara da Serra", "Lucas do Rio Verde", "Nova Mutum", "Sorriso", "Sinop", "Araguaina", "Palmas"];
        const EPS_RADIANTE_RJ = ["Araruama", "Armacao dos Buzios", "Cabo Frio", "Iguaba Grande", "Itaperuna", "Petropolis", "Rio Bonito", "Rio das Ostras", "Angra dos Reis", "Barra Mansa", "Barra do Pirai", "Mangaratiba", "Nova Friburgo", "Paraty", "Resende", "Volta Redonda", "Sao Pedro da Aldeia", "Teresopolis", "Tres Rios", "Valenca"];
        const EPS_RADIANTE_RS = ["Carlos Barbosa", "Dois Irmaos", "Erechim", "Flores da Cunha", "Garibaldi", "Ivoti", "Capao da Canoa", "Nova Petropolis", "Osorio", "Sao Marcos", "Torres", "Taquara", "Tramandai", "Veranopolis", "Xangri-la", "Alegrete", "Bage", "Camaqua", "Cachoeira do Sul", "Canela", "Carazinho", "Charqueadas", "Estrela", "Gramado", "Igrejinha", "Ijui", "Lajeado", "Lagoa Vermelha", "Palmeira das Missoes", "Sant'Ana do Livramento", "Sarandi", "Teutonia", "Uruguaiana", "Vacaria", "Venancio Aires"];
        const EPS_RADIANTE_MG = ["Divinopolis", "Ribeirao das Neves", "Sete Lagoas", "Santa Luzia", "Tres Coracoes", "Timoteo", "Tres Pontas", "Varginha", "Pocos de Caldas", "Pouso Alegre", "Santa Rosa", "Santo Angelo", "Tres de Maio", "Nova Lima"];
        const EPS_FIBRASIL = ["Cachoeiro de Itapemirim", "Guarapari", "Santa Maria de Jetiba", "Viana", "Aracruz", "Sao Mateus"];
        const EPS_TLP = ["Concordia", "Capinzal", "Fraiburgo", "Garopaba", "Imbituba", "Mafra", "Navegantes", "Pomerode", "Rio do Sul", "Sao Bento do Sul"];
        const EPS_TECNOMULTI = ["Cabedelo", "Patos", "Garanhuns", "Mossoro", "Parnamirim"];
        const EPS_ABILITY = ["Formosa", "Itaberai", "Inhumas", "Ji-Parana"];
        const EPS_VIRTEX = ["Picos", "Teresina"          
        ];        
        const UF_AL = ["Arapiraca"];
        const UF_AM = ["Manaus"];
        const UF_AP = ["Macapa"];
        const UF_BA = ["Arraial D'Ajuda", "Barreiras", "Eunapolis", "Guanambi", "Ilheus", "Jequie", "Luis Eduardo Magalhaes", "Porto Seguro", "Santo Antonio de Jesus", "Teixeira de Freitas", "Trancoso", "Vitoria da Conquista"];
        const UF_CE = ["Crato", "Juazeiro do Norte", "Sobral"];
        const UF_ES = ["Cachoeiro de Itapemirim", "Guarapari", "Santa Maria de Jetiba", "Viana", "Aracruz", "Sao Mateus"];
        const UF_GO = ["Jaragua", "Jatai", "Mineiros", "Caldas Novas", "Catalao", "Itumbiara", "Morrinhos", "Formosa", "Itaberai", "Inhumas"];
        const UF_MA = ["Acailandia", "Balsas", "Imperatriz", "Paco do Lumiar", "Santa Ines", "Sao Jose de Ribamar", "Sao Luis"];
        const UF_MG = ["Uberlandia", "Uberaba", "Ibirite", "Divinopolis", "Ribeirao das Neves", "Sete Lagoas", "Santa Luzia", "Tres Coracoes", "Timoteo", "Tres Pontas", "Varginha", "Pocos de Caldas", "Pouso Alegre", "Nova Lima"];
        const UF_MS = ["Tres Lagoas"];
        const UF_MT = ["Campo Verde", "Primavera do Leste", "Tangara da Serra", "Lucas do Rio Verde", "Nova Mutum", "Sorriso", "Sinop"];
        const UF_PA = ["Altamira", "Belem", "Castanhal", "Canaa dos Carajas", "Capanema", "Paragominas", "Parauapebas", "Redencao", "Tucurui"];
        const UF_PB = ["Cabedelo", "Patos"];
        const UF_PE = ["Petrolina", "Garanhuns"];
        const UF_PI = ["Parnaiba", "Picos", "Teresina"];
        const UF_RJ = ["Araruama", "Armacao dos Buzios", "Cabo Frio", "Iguaba Grande", "Itaperuna", "Petropolis", "Rio Bonito", "Rio das Ostras", "Angra dos Reis", "Barra Mansa", "Barra do Pirai", "Mangaratiba", "Nova Friburgo", "Paraty", "Resende", "Volta Redonda", "Sao Pedro da Aldeia", "Teresopolis", "Tres Rios", "Valenca"];
        const UF_RN = ["Mossoro", "Parnamirim"];
        const UF_RO = ["Ji-Parana"];
        const UF_RS = ["Carlos Barbosa", "Dois Irmaos", "Erechim", "Flores da Cunha", "Garibaldi", "Ivoti", "Capao da Canoa", "Nova Petropolis", "Osorio", "Sao Marcos", "Torres", "Taquara", "Tramandai", "Veranopolis", "Xangri-la", "Santa Rosa", "Santo Angelo", "Tres de Maio", "Alegrete", "Bage", "Camaqua", "Cachoeira do Sul", "Canela", "Carazinho", "Charqueadas", "Estrela", "Gramado", "Igrejinha", "Ijui", "Lajeado", "Lagoa Vermelha", "Palmeira das Missoes", "Sant'Ana do Livramento", "Sarandi", "Teutonia", "Uruguaiana", "Vacaria", "Venancio Aires"];
        const UF_SC = ["Concordia", "Capinzal", "Fraiburgo", "Garopaba", "Imbituba", "Mafra", "Navegantes", "Pomerode", "Rio do Sul", "Sao Bento do Sul"];
        const UF_SE = ["Lagarto"];
        const UF_TO = ["Araguaina", "Palmas"
        ];
        const UF_SAGRE = ["Aracruz", "Sao Mateus", "Tres Pontas", "Varginha", "Caldas Novas", "Catalao", "Itumbiara", "Morrinhos", "Santa Rosa", "Santo Angelo", "Tres de Maio"
        ];
        
        // --- AUXILIARES ---
        function normalizeString(str) {
            return String(str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
        }

        function findKeyFuzzy(obj, keywords) {
            const keys = Object.keys(obj);
            for (let key of keys) {
                const normKey = normalizeString(key);
                if (keywords.some(k => normKey.includes(normalizeString(k)))) return key;
            }
            return null;
        }

        function cleanHistoryComment(histRaw) {
            if (!histRaw) return "";
            let blocks = String(histRaw).split(/\n\s*\n/).filter(b => b.trim().length > 0);
            
            let selected = "";
            if (blocks.length > 0) {
                // Percorre de trás para frente ignorando mensagens indesejadas
                for (let i = blocks.length - 1; i >= 0; i--) {
                    let b = blocks[i].trim();
                    let bLow = b.toLowerCase();
                    
                    const isAutomaticSuccess = b.includes(TARGET_TEXT_TA);
                    const isAutomaticFail = bLow.includes("passagem automática com falha") || 
                                          bLow.includes("nenhum município encontrado") || 
                                          bLow.includes("não foi possível designar equipe responsável") ||
                                          bLow.includes("fibrasil_ms");
                    const isGeneralAuto = bLow.includes("notificação de ta");
                    const isImage = bLow.includes("!#image.png#!"); // Regra 1: Remove mensagens com imagem
                    const isTechDump = (b.includes("----------------") && (bLow.includes("position") || bLow.includes("tx-power") || bLow.includes("diag-avail-status")));
                    
                    // Critério para filtrar blocos puramente informativos de contatos (antes de tentar extrair a atividade)
                    const isPureContactInfo = (bLow.includes("nome do técnico") || bLow.includes("supervisor ciente")) && !bLow.includes("descrição da atividade");

                    if (!isAutomaticSuccess && !isAutomaticFail && !isGeneralAuto && !isImage && !isTechDump && !isPureContactInfo) {
                        selected = b; 
                        break;
                    }
                }
            }
            
            // --- REGRA DE FALLBACK: Se estiver vazio, pega a penúltima focando em previsões ---
            if ((!selected || selected.trim() === "") && blocks.length > 1) {
                for (let j = blocks.length - 2; j >= 0; j--) {
                    let prevB = blocks[j].trim();
                    let prevBLow = prevB.toLowerCase();
                    if (!prevBLow.includes("!#image.png#!") && (prevBLow.includes("previsão") || prevBLow.includes("previsto") || prevBLow.includes(" h"))) {
                        selected = prevB;
                        break;
                    }
                }
            }

            if (!selected || selected.trim() === "") {
                selected = "Aguardando atualização EPS";
            } else {
                // --- REGRA 2: Extrair apenas o que vem após "Descrição da atividade:" ---
                let lowSelected = selected.toLowerCase();
                if (lowSelected.includes("descrição da atividade:")) {
                    const marker = "descrição da atividade:";
                    const index = lowSelected.indexOf(marker);
                    selected = selected.substring(index + marker.length).trim();
                }

                // Limpeza padrão de cabeçalhos e prefixos
                const dateMatch = selected.match(DATE_STAMP_REGEX);
                if (dateMatch) selected = selected.substring(dateMatch.index + dateMatch[0].length).trim();
                selected = selected.replace(/^ATUALIZAÇÃO\s+CCR(\s+TTK)?[:\s]*/i, "").trim();
            }

            // --- REGRA 3: Formatação (Caixa Grande, Sem Espaços Extras) e Limite de 100 caracteres ---
            selected = selected.replace(/\s+/g, ' ').trim().toUpperCase();
            
            if (selected.length > 100) {
                selected = selected.substring(0, 97) + "...";
            }
            
            return selected;
        }

        // --- NAVEGAÇÃO ---
        function switchPage(page) {
            const body = document.getElementById('main-body');
            document.getElementById('page-operacoes').classList.toggle('hidden', page !== 'operacoes');
            document.getElementById('page-volumetria').classList.toggle('hidden', page !== 'volumetria');
            body.classList.toggle('volumetria-mode', page === 'volumetria');
            window.scrollTo(0, 0);

            // Atualiza a URL sem recarregar a página
            const url = new URL(window.location);
            if (page === 'volumetria') {
                url.searchParams.set('page', 'volumetria');
                // Fix: Re-renderiza os dados ao entrar na aba para corrigir gráficos do Chart.js (canvas oculto)
                if (globalVolData && globalVolData.length > 0) {
                    setTimeout(() => runVolAnalysis(globalVolData), 50);
                }
                loadDefaultFiles();
            } else {
                url.searchParams.delete('page');
            }
            window.history.pushState({}, '', url);
        }

        function toggleAdminMode() {
            isAdminMode = !isAdminMode;
            const btn = document.getElementById('btnAdmin');
            const viewControls = document.getElementById('pendenciaViewControls');
            const kpiBreakdown = document.getElementById('kpi-breakdown');
            if (isAdminMode) {
                btn.classList.replace('bg-gray-800', 'bg-green-600');
                if(viewControls) viewControls.classList.remove('hidden');
                if(kpiBreakdown) kpiBreakdown.classList.remove('hidden');
            } else {
                btn.classList.replace('bg-green-600', 'bg-gray-800');
                if(viewControls) viewControls.classList.add('hidden');
                if(kpiBreakdown) kpiBreakdown.classList.add('hidden');
            }
            filterByDate();
        }

        // Verifica se a URL pede para iniciar na Volumetria
        const params = new URLSearchParams(window.location.search);
        if (params.get('page') === 'volumetria') {
            // Executa imediatamente se o script estiver no final do body
            const body = document.getElementById('main-body');
            document.getElementById('page-operacoes').classList.add('hidden');
            document.getElementById('page-volumetria').classList.remove('hidden');
            body.classList.add('volumetria-mode');
            loadDefaultFiles();
        }

        // --- MODAL FUNCTIONS ---
        function openTagDetailsModal(tagName) {
            let list = tagDetailsLists[tagName] || [];
            document.getElementById('modalAnalista').innerText = tagName;
            document.getElementById('modalSubTitle').innerText = "Lista detalhada de referências e tags registradas";
            document.getElementById('btnExtrairModal').classList.add('hidden');
            
            const content = document.getElementById('modalContent');
            if (list.length === 0) {
                content.innerHTML = '<p class="text-center text-slate-300 py-10 uppercase font-black italic">Sem registos encontrados para esta tag.</p>';
            } else {
                let extraHeader = "";
                let isCrisis = false;
                if (tagName === 'SALAS COPE' || tagName === 'SALAS NOC') {
                    isCrisis = true;
                    extraHeader = '<th class="p-3">SALA DE CRISE</th>';
                    
                    // Deduplicação baseada na coluna SALA DE CRISE
                    const seen = new Set();
                    const uniqueList = [];
                    list.forEach(item => {
                        let tagVal = String(item.tag || "");
                        let displayVal = tagName === 'SALAS COPE' ? tagVal.slice(-5) : tagVal.slice(-4);
                        if (tagName === 'SALAS COPE' && !/^C\d{4}$/i.test(displayVal)) {
                            const match = tagVal.match(/C\d{4}/i);
                            if (match) displayVal = match[0];
                        }
                        const key = displayVal.toUpperCase().trim();
                        if (!seen.has(key)) { seen.add(key); uniqueList.push({ ...item, _displayVal: displayVal }); }
                    });
                    list = uniqueList;
                }
                content.innerHTML = `<table class="w-full text-left border-collapse min-w-max">
                    <thead><tr class="bg-slate-900 text-white uppercase text-[10px] font-black"><th class="p-3">Referência</th>${extraHeader}<th class="p-3">TAG Original</th></tr></thead>
                    <tbody class="divide-y divide-slate-100">
                        ${list.map(item => {
                            let extraCol = "";
                            if (isCrisis) {
                                extraCol = `<td class="p-3 text-slate-700 text-[10px] font-black uppercase">${item._displayVal}</td>`;
                            }
                            return `<tr><td class="p-3 font-black text-slate-700">${item.ref}</td>${extraCol}<td class="p-3 text-slate-500 text-[10px] font-black uppercase">${item.tag}</td></tr>`;
                        }).join('')}
                    </tbody></table>`;
            }
            document.getElementById('detailsModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalBox').classList.add('scale-100'), 10);
        }

        function openCausaModal(causaName) {
            const list = globalVolData.filter(row => {
                const keyCausa = findKeyFuzzy(row, ['Causa']);
                const val = normalizeString(row[keyCausa] || 'N/A');
                return val === causaName;
            });

            if (list.length === 0) return;

            document.getElementById('modalAnalista').innerText = causaName;
            document.getElementById('modalSubTitle').innerText = `Detalhamento por Causa - ${list.length} registros`;

            const btnExport = document.getElementById('btnExtrairModal');
            btnExport.classList.remove('hidden');
            btnExport.onclick = function() {
                const ws = XLSX.utils.json_to_sheet(list.map(({_filterDate, ...rest}) => rest));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Dados");
                XLSX.writeFile(wb, `EXPORT_CAUSA_${causaName.replace(/[^a-z0-9]/gi, '_')}.xlsx`);
            };

            const content = document.getElementById('modalContent');
            let headers = Object.keys(list[0]).filter(k => k !== '_filterDate');
            
            const headerHtml = headers.map(h => `<th class="p-3 whitespace-nowrap">${h}</th>`).join('');
            const displayList = list.slice(0, 100);
            const bodyHtml = displayList.map(row => `<tr>${headers.map(h => `<td class="p-3 whitespace-nowrap border-b border-slate-100">${row[h] || ''}</td>`).join('')}</tr>`).join('');
            
            content.innerHTML = `<div class="overflow-auto max-h-[60vh]"><table class="w-full text-left border-collapse text-[10px]"><thead><tr class="bg-slate-900 text-white font-black sticky top-0">${headerHtml}</tr></thead><tbody class="font-medium text-slate-600">${bodyHtml}</tbody></table></div>${list.length > 100 ? '<p class="text-xs text-center mt-2 text-slate-400 font-bold uppercase">Exibindo os primeiros 100 registros. Exporte para ver tudo.</p>' : ''}`;
            document.getElementById('detailsModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalBox').classList.add('scale-100'), 10);
        }

        function openKpiModal(type) {
            let list = kpiData[type];
            if (type === 'es') list = volDataES;
            if (!list || list.length === 0) return;
            
            const titleMap = { total: 'Total de tickets verificados', agregadores: 'Agregadores', agregado: 'Agregado', es: 'Total Espírito Santo', acoes: 'Ações Analistas' };
            document.getElementById('modalAnalista').innerText = titleMap[type] || type.toUpperCase();
            document.getElementById('modalSubTitle').innerText = `Listagem completa - ${list.length} registros`;
            
            const btnExport = document.getElementById('btnExtrairModal');
            btnExport.classList.remove('hidden');
            btnExport.onclick = function() {
                const ws = XLSX.utils.json_to_sheet(list);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Dados");
                XLSX.writeFile(wb, `EXPORT_${type.toUpperCase()}.xlsx`);
            };

            const content = document.getElementById('modalContent');
            let headers = Object.keys(list[0]);

            // Reordenar colunas: Área Rede -> Referência -> Causa
            const findH = (keywords) => headers.find(h => keywords.some(k => normalizeString(h).includes(normalizeString(k))));
            const keyArea = findH(['Área Rede', 'Região', 'AREA REDE']);
            const keyRef = findH(['Referência', 'TT', 'REFERENCIA']);
            const keyCausa = findH(['Causa', 'CAUSA']);

            if (keyArea && keyRef && keyCausa) {
                headers = headers.filter(h => h !== keyArea && h !== keyRef && h !== keyCausa);
                headers.unshift(keyArea, keyRef, keyCausa);
            }

            const headerHtml = headers.map(h => `<th class="p-3 whitespace-nowrap">${h}</th>`).join('');
            const displayList = list.slice(0, 100); 
            const bodyHtml = displayList.map(row => `<tr>${headers.map(h => `<td class="p-3 whitespace-nowrap border-b border-slate-100">${row[h] || ''}</td>`).join('')}</tr>`).join('');
            
            content.innerHTML = `<div class="overflow-auto max-h-[60vh]"><table class="w-full text-left border-collapse text-[10px]"><thead><tr class="bg-slate-900 text-white font-black sticky top-0">${headerHtml}</tr></thead><tbody class="font-medium text-slate-600">${bodyHtml}</tbody></table></div>${list.length > 100 ? '<p class="text-xs text-center mt-2 text-slate-400 font-bold uppercase">Exibindo os primeiros 100 registros. Exporte para ver tudo.</p>' : ''}`;
            document.getElementById('detailsModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalBox').classList.add('scale-100'), 10);
        }

        function openAcoesModal() {
            if (!kpiData.total || kpiData.total.length === 0) return;
            
            const filtered = kpiData.total.filter(row => {
                const keyHist = findKeyFuzzy(row, ['Historico', 'Histórico', 'comentarios']);
                const keyUser = findKeyFuzzy(row, ['Usuário Envolvido', 'Usuario', 'Envolvido']);
                
                const histVal = normalizeString(row[keyHist]);
                const userVal = normalizeString(row[keyUser]);
                
                return ANALISTAS_ALVO.some(analista => {
                    const normAnalista = normalizeString(analista);
                    return histVal.includes(normAnalista) || userVal.includes(normAnalista);
                });
            });

            kpiData.acoes = filtered;
            openKpiModal('acoes');
        }

        function openTotalPendenciasModal() {
            if (masterPendenciasList.length === 0) return;
            document.getElementById('modalAnalista').innerText = "TOTAL GERAL DE PENDÊNCIAS";
            document.getElementById('modalSubTitle').innerText = "Lista unificada de todas as pendências identificadas";
            document.getElementById('btnExtrairModal').classList.remove('hidden');
            const btnExport = document.getElementById('btnExtrairModal');
            btnExport.classList.remove('hidden');
            btnExport.onclick = exportModalDataToExcel;
            const content = document.getElementById('modalContent');
            content.innerHTML = `<table id="totalPendenciasTable" class="w-full text-left border-collapse min-w-[1200px]">
                <thead><tr class="bg-blue-900 text-white uppercase text-[10px] font-black">
                <th class="p-3">Referência</th><th class="p-3">Analista</th><th class="p-3">Causa Detectada</th>
                <th class="p-3">Nº IDs com Agregados</th><th class="p-3">UF</th><th class="p-3">ÁREA REDE</th>
                <th class="p-3">TAG</th><th class="p-3">Data Início</th><th class="p-3">Data Fim</th><th class="p-3">Histórico</th><th class="p-3">Coordenador Responsável</th><th class="p-3">EPS</th></tr></thead>
                <tbody class="divide-y divide-slate-100">
                ${masterPendenciasList.map(p => `<tr>
                    <td class="p-3 font-black text-slate-700 align-top">${p.ref}</td>
                    <td class="p-3 text-slate-500 text-[10px] font-black align-top">${p.analista}</td>
                    <td class="p-3 text-red-600 text-[10px] font-black align-top">${p.causa}</td>
                    <td class="p-3 text-blue-600 text-[10px] font-black align-top text-center">${p.ids}</td>
                    <td class="p-3 text-slate-500 text-[10px] font-black align-top">${p.uf}</td>
                    <td class="p-3 text-slate-500 text-[10px] font-black align-top">${p.area}</td>
                    <td class="p-3 text-slate-500 text-[10px] font-black align-top">${p.tag}</td>
                    <td class="p-3 text-slate-500 text-[10px] font-black align-top">${p.dataInicio || '-'}</td>
                    <td class="p-3 text-slate-500 text-[10px] font-black align-top">${p.dataFim || '-'}</td>
                    <td class="p-3 text-slate-600 text-xs uppercase leading-relaxed">${p.msg}</td>
                    <td class="p-3 text-slate-800 text-[10px] font-black align-top">${p.coordenador || '-'}</td>
                    <td class="p-3 text-slate-800 text-[10px] font-black align-top">${p.eps || '-'}</td>
                </tr>`).join('')}
                </tbody></table>`;
            document.getElementById('detailsModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalBox').classList.add('scale-100'), 10);
        }

        function togglePendenciasBox() {
            const container = document.getElementById('analistas-list-container');
            const icon = document.getElementById('toggle-icon');
            container.classList.toggle('hidden');
            icon.className = container.classList.contains('hidden') ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
        }

        function openDetailsModal(keyName) {
            const mode = pendenciasViewMode;
            const details = mode === 'causa' ? currentCausaPendenciaDetails[keyName] : currentAnalistaPendenciaDetails[keyName];
            document.getElementById('modalAnalista').innerText = keyName;
            document.getElementById('modalSubTitle').innerText = `Detalhamento de Pendências (${mode === 'causa' ? 'Causa' : 'Usuário'})`;
            document.getElementById('btnExtrairModal').classList.add('hidden');
            const content = document.getElementById('modalContent');
            if (!details || details.length === 0) {
                content.innerHTML = '<p class="text-center text-slate-300 py-10 uppercase font-black italic">Sem pendências.</p>';
            } else {
                content.innerHTML = `<table class="w-full text-left border-collapse min-w-max"><thead><tr class="bg-slate-900 text-white uppercase text-[10px] font-black">
                    <th class="p-3">Referência</th><th class="p-3">Área Rede</th><th class="p-3">Histórico</th></tr></thead><tbody class="divide-y divide-slate-100">
                    ${details.map(d => `<tr><td class="p-3 font-black text-slate-700 align-top">${d.ref}</td><td class="p-3 text-[10px] uppercase font-bold text-slate-500">${d.area}</td><td class="p-3 text-slate-600 text-xs uppercase leading-relaxed">${d.msg}</td></tr>`).join('')}
                    </tbody></table>`;
            }
            document.getElementById('detailsModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalBox').classList.add('scale-100'), 10);
        }

        function closeModal() {
            document.getElementById('modalBox').classList.remove('scale-100');
            setTimeout(() => document.getElementById('detailsModal').classList.add('hidden'), 300);
        }

        function showImportLigacoesModal() {
            document.getElementById('confirmImportModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('confirmModalBox').classList.add('scale-100'), 10);
        }
        function closeConfirmModal() {
            document.getElementById('confirmModalBox').classList.remove('scale-100');
            setTimeout(() => document.getElementById('confirmImportModal').classList.add('hidden'), 300);
        }
        function triggerLigacoesImport() {
            closeConfirmModal();
            document.getElementById('fileInputLigacoesCope').click();
        }

        function cyclePendenciaView() {
            const modes = ['causa', 'usuario', 'turnos'];
            const labels = { 'causa': 'Causas', 'usuario': 'Usuários', 'turnos': 'Turnos' };
            let idx = modes.indexOf(pendenciasViewMode);
            idx = (idx + 1) % modes.length;
            pendenciasViewMode = modes[idx];
            const btn = document.getElementById('pendenciaViewControls');
            if (btn) btn.innerText = labels[pendenciasViewMode];
            renderPendenciasList();
        }

        function exportModalDataToExcel() {
            if (masterPendenciasList.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(masterPendenciasList);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Pendencias_Totais");
            XLSX.writeFile(wb, "TOTAL_PENDENCIAS_DASHBOARD.xlsx");
        }

        // --- LÓGICA TA / CAUSA ---
        function clearTA() { processedTA = []; document.getElementById('results-ta').classList.add('hidden'); document.getElementById('fileInputTA').value = ""; }
        function downloadTA() {
            const ws = XLSX.utils.json_to_sheet(processedTA.map(({_mod, ...r}) => r));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "TA");
            XLSX.writeFile(wb, "ARQUIVO_PARCIAL_LIMPO.xlsx");
            window.open("https://parcialcopepadtec.streamlit.app/", "_blank");
        }
        function clearCausa() { processedCausa = []; document.getElementById('results-causa').classList.add('hidden'); document.getElementById('fileInputCausa').value = ""; }
        function downloadCausaExcel() { const ws = XLSX.utils.json_to_sheet(processedCausa); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Causa"); XLSX.writeFile(wb, "CAUSA_COMUM.xlsx"); }

        document.getElementById('fileInputTA').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            document.getElementById('loadingTA').classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { range: 1, defval: "" });
                processedTA = data.map(row => {
                    const cleanHist = cleanHistoryComment(row['Histórico Comentários']);
                    const newRow = { ...row, 'Histórico Comentários': cleanHist, _mod: ['Histórico Comentários'] };
                    if (!String(row['UF']).trim()) {
                        const match = String(row['Equipe Responsável']).match(/\/\s*([A-Z]{2})/i);
                        if (match) { newRow['UF'] = match[1].toUpperCase(); newRow._mod.push('UF'); }
                    }
                    return newRow;
                });
                headersTA = Object.keys(processedTA[0]).filter(k => k !== '_mod');
                renderTA();
                document.getElementById('stats-ta').innerText = `${processedTA.length} lidos.`;
                document.getElementById('results-ta').classList.remove('hidden');
                document.getElementById('loadingTA').classList.add('hidden');
            };
            reader.readAsArrayBuffer(file);
        });

        function renderTA() {
            document.getElementById('headTA').innerHTML = `<tr>${headersTA.map(h => `<th>${h}</th>`).join('')}</tr>`;
            document.getElementById('bodyTA').innerHTML = processedTA.slice(0, 30).map(row => `<tr>${headersTA.map(h => `<td class="${row._mod.includes(h) ? 'modified-cell' : ''} ${h === 'Histórico Comentários' ? 'col-historico' : ''}">${row[h]}</td>`).join('')}</tr>`).join('');
        }

        document.getElementById('fileInputCausa').addEventListener('change', function(e){
            const file = e.target.files[0]; if (!file) return;
            document.getElementById('loadingCausa').classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = function(e){
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array'});
                handleCausa(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { range: 1 }));
            };
            reader.readAsArrayBuffer(file);
        });

        function handleCausa(data) {
            const clean = data.map(row => {
                const n = {}; Object.keys(row).forEach(k => n[k.trim().replace(/\s+/g, ' ')] = row[k]);
                return { ...n, Cidade: String(n['Área Rede'] || '').replace(/^-+/,'').trim(), ContemTag: String(n['Tag'] || '').toUpperCase().includes('DESAGREGADO') ? 'Contém TAG' : 'Sem TAG', SubCat: n['Sub-Categoria'] || n['Sub categoria'] || '' };
            });
            const counts = {};
            clean.forEach(r => { if(r['Splitter Designado']) counts[r['Splitter Designado']] = (counts[r['Splitter Designado']] || 0) + 1; });
            processedCausa = clean.filter(r => r['Splitter Designado'] && counts[r['Splitter Designado']] > 1).sort((a,b) => a.Cidade.localeCompare(b.Cidade) || String(a['Splitter Designado']).localeCompare(String(b['Splitter Designado'])));
            renderCausa();
            document.getElementById('stats-causa').innerText = `${processedCausa.length} duplicados.`;
            document.getElementById('results-causa').classList.remove('hidden');
            document.getElementById('loadingCausa').classList.add('hidden');
        }

        function renderCausa() {
            const body = document.getElementById('bodyCausa'); body.innerHTML = "";
            processedCausa.forEach((r, i) => {
                const tr = document.createElement('tr'); if(r.ContemTag === 'Contém TAG') tr.classList.add('bg-green-50');
                const vls = [r.Cidade, r['Splitter Designado'], r['Nome CI'], r.SubCat, r['Referência'], r['Tag'] || '', r.ContemTag];
                vls.forEach((v, idx) => {
                    const td = document.createElement('td');
                    if (idx === 6 && v === 'Contém TAG') td.innerHTML = `<span class="bg-green-500 text-white px-2 py-1 rounded text-[10px] font-bold uppercase">Contém TAG</span>`;
                    else if (idx === 3 && String(v).toUpperCase().includes('PORTA CTO COM DEFEITO')) td.innerHTML = `<span class="text-red-600 line-through font-medium">${v}</span>`;
                    else td.textContent = v;
                    tr.appendChild(td);
                });
                body.appendChild(tr);
                if(i < processedCausa.length - 1 && processedCausa[i].Cidade !== processedCausa[i+1].Cidade) body.innerHTML += '<tr class="blank-row"><td colspan="7"></td></tr>';
            });
        }

        // --- LÓGICA VOLUMETRIA ---
        document.getElementById('fileInputVol').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rowsRaw = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                let hIdx = rowsRaw.findIndex(r => r && r.some(c => normalizeString(c).includes('CAUSA')));
                if (hIdx === -1 && rowsRaw.length > 1 && (!rowsRaw[0] || rowsRaw[0].length === 0)) hIdx = 1;
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { range: hIdx === -1 ? 0 : hIdx });
                processVolData(jsonData.filter(r => Object.values(r).some(v => v !== null && v !== "")));
                showImportLigacoesModal();
            };
            reader.readAsArrayBuffer(file);
        });

        let causasPendenciaMap = {};
        let analistasPendenciaMap = {};
        let dailyTotalsMap = {};
        let globalVolData = [];

        function processVolData(data) {
            globalVolData = [];
            activeMonthFilter = null;
            const dateSet = new Set();
            
            data.forEach(row => {
                const keyData = findKeyFuzzy(row, ['Data Fim']);
                let dateStr = "N/A";
                if (keyData && row[keyData]) {
                     const val = row[keyData];
                     let d;
                     if (typeof val === 'number') {
                         d = new Date(Math.round((val - 25569) * 86400 * 1000));
                     } else {
                         const p = String(val).split(' ')[0].split(/[-/]/);
                         if (p.length === 3) {
                             d = p[0].length === 4 ? new Date(p[0], p[1]-1, p[2]) : new Date(p[2], p[1]-1, p[0]);
                         } else {
                             d = new Date(val);
                         }
                     }
                     if (d && !isNaN(d.getTime())) {
                         dateStr = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
                     }
                }
                row._filterDate = dateStr;
                if (dateStr !== "N/A") dateSet.add(dateStr);
                globalVolData.push(row);
            });

            const filterSelect = document.getElementById('dateFilter');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="all" class="text-slate-800">Geral</option>';
                const sortedDates = Array.from(dateSet).sort((a, b) => {
                    const [da, ma, ya] = a.split('/').map(Number);
                    const [db, mb, yb] = b.split('/').map(Number);
                    return new Date(ya, ma-1, da) - new Date(yb, mb-1, db);
                });
                sortedDates.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    opt.className = "text-slate-800";
                    filterSelect.appendChild(opt);
                });
            }

            const monthsSet = new Set();
            globalVolData.forEach(r => {
                if (r._filterDate && r._filterDate !== "N/A") {
                    const parts = r._filterDate.split('/');
                    if (parts.length === 3) monthsSet.add(`${parts[1]}/${parts[2]}`);
                }
            });
            renderMonthButtons(Array.from(monthsSet));

            runVolAnalysis(globalVolData);
        }

        function filterByDate() {
            const selected = document.getElementById('dateFilter').value;
            if (selected === 'all') {
                runVolAnalysis(globalVolData);
            } else {
                const filtered = globalVolData.filter(r => r._filterDate === selected);
                runVolAnalysis(filtered);
            }
        }

        let activeMonthFilter = null;
        function renderMonthButtons(months) {
            const container = document.getElementById('monthFilterContainer');
            if (!container) return;
            container.innerHTML = '';
            if (months.length === 0) return;

            months.sort((a, b) => {
                const [m1, y1] = a.split('/').map(Number);
                const [m2, y2] = b.split('/').map(Number);
                return (y1 - y2) || (m1 - m2);
            });

            months.forEach(mStr => {
                const [m, y] = mStr.split('/');
                const monthName = MONTH_NAMES[parseInt(m) - 1];
                const btn = document.createElement('button');
                btn.className = "btn-view-toggle text-[9px] px-2 py-1";
                btn.innerText = `${monthName}/${y}`;
                btn.onclick = () => filterByMonth(mStr, btn);
                container.appendChild(btn);
            });
        }

        function filterByMonth(monthYear, btnElement) {
            const container = document.getElementById('monthFilterContainer');
            const buttons = container.querySelectorAll('button');
            const isSame = activeMonthFilter === monthYear;
            
            activeMonthFilter = isSame ? null : monthYear;
            buttons.forEach(b => b.classList.remove('active'));
            if (!isSame) btnElement.classList.add('active');

            const dateSelect = document.getElementById('dateFilter');
            if(dateSelect) dateSelect.value = 'all';

            if (activeMonthFilter) {
                const filtered = globalVolData.filter(r => {
                    if (!r._filterDate || r._filterDate === "N/A") return false;
                    const parts = r._filterDate.split('/');
                    return `${parts[1]}/${parts[2]}` === activeMonthFilter;
                });
                runVolAnalysis(filtered);
            } else {
                runVolAnalysis(globalVolData);
            }
        }

        function runVolAnalysis(data) {
            const s = { 
                totalSet: new Set(), agrSet: new Set(), agrsSet: new Set(),
                total: 0, agr: 0, agrs: 0, 
                admSet: new Set(), desSet: new Set(), scSet: new Set(), snSet: new Set(), 
                scAgg: 0, scB2b: 0, scPon: 0,
                es: 0, esC: {}, d: [] 
            };
            kpiData = { total: [], agregadores: [], agregado: [] };
            const cmSets = {}, esm = {}, rm = {}, tm = {};
            const categoryMapping = [
                { id: "CHUVA", kw: ["CHUVA"] }, { id: "SEM ACESSO", kw: ["SEM ACESSO"] },
                { id: "AREA DE RISCO", kw: ["AREA DE RISCO"] }, { id: "POSTE ENERGIZADO", kw: ["POSTE ENERGIZADO", "CIA DE ENERGIA", "EMPRESA DE ENERGIA"] },
                { id: "TROCA DE POSTE", kw: ["TROCA DE POSTE"] }
            ];
            const includeKeywords = ["SEM ACESSO", "AREA DE RISCO", "POSTE ENERGIZADO", "CHUVA NO LOCAL", "CHUVA", "EMPRESA DE ENERGIA NO LOCAL", "CIA DE ENERGIA", "TROCA DE POSTE", "SERA LIBERA AS", "SERA TRATADO DIA", "PENDENCIA ALTORIZADA", "PENDENTE ATE"];
            
            causasPendenciaMap = {}; analistasPendenciaMap = {}; dailyTotalsMap = {};
            currentCausaPendenciaDetails = {}; currentAnalistaPendenciaDetails = {}; masterPendenciasList = [];
            tagDetailsLists = { 'ADM COPE': [], 'DESAGREGADO': [], 'SALAS COPE': [], 'SALAS NOC': [] };
            volDataES = [];

            const TARGET_USERS_FOR_COUNT = [
                "LUAN VIEIRA LOPES", "JULIANA COSTA PEREIRA DA SILVA", "BRUNO MELLO DA SILVA", 
                "TAMIRIS AVELINA GONÇALVES", "RANDU MATOS MENEZES", "ELVIS MIRANDA", 
                "NOC/JEFFERSON", "NOC/JOSEYLSON"
            ];

            const EXCLUDED_CAUSES = [
                "ACESSO DE TERCEIROS", "ACIONAMENTO IMPROCEDENTE VIVO", "ALIVIO FISICO", "AR CONDICIONADO - BAIXA EFICIENCIA", "AR CONDICIONADO INOPERANTE", "AUSENCIA DE CONFIGURACAO", "AUTENTICACAO DUPLICADA", "BANCO DE BATERIAS - BAIXA EFICIENCIA", "BATERIA EM DESCARGA", "CAIXA NAO LOCALIZADA", "CAIXA SEM CONECTIVIDADE", "CLIMATIZACAO", "CONCESSIONARIA ELETRICA", "CONECTIVIDADE", "CONFIGURACAO DE PERIMETRO DA CAMERA", "CORDAO OPTICO DEFEITUOSO", "DISJUNTOR DESARMADO", "DISJUNTOR/FUSIVEL COM DEFEITO", "DIVERGENCIA DE CADASTRO", "DIVERGENCIA PROFILE", "ENDERECO INCORRETO", "ENDERECO NAO COBERTO", "ERRO CONSTRUCAO", "ERRO NA APLICACAO", "FALHA CONFIGURACAO", "FALHA DE GERENCIA DO ELEMENTO DE REDE (OLT, AGG E BNG)", "FALHA DO SERVIDOR DE GERENCIA (A M S - NOKIA, NCE - HUAWEI)", "FALHA ENERGIA", "FALHA FANS/FILTROS", "FALHA HARDWARE", "FALHA OPERACIONAL", "FALHA OPERADORA", "FALHA SOFTWARE", "FURTO", "INTEMPERIE", "LIMPEZA DE DROP", "LINK DOWN", "MANOBRA DE CTO", "MANOBRA DE PORTA", "NAO HA FALHA", "NORMALIZADO PELA CONCESSIONARIA", "ORDEM FAILED", "ORDEM HELD", "PLACA CONTROLADORA COM DEFEITO", "SFP", "SFP COM DEFEITO", "TRABALHOS PROGRAMADOS"
            ];

            data.forEach(row => {
                const keyAg = findKeyFuzzy(row, ['Agregação']);
                const keyTag = findKeyFuzzy(row, ['Tag']);
                const keyArea = findKeyFuzzy(row, ['Área Rede', 'Região']);
                const keyCausa = findKeyFuzzy(row, ['Causa']);
                const keyHist = findKeyFuzzy(row, ['HISTORICO']);
                const keyData = findKeyFuzzy(row, ['Data Fim']);
                const keyDataInicio = findKeyFuzzy(row, ['Data Inicio', 'Data Início']);
                const keyRef = findKeyFuzzy(row, ['Referência', 'TT']);
                const keyUF = findKeyFuzzy(row, ['UF', 'Estado', 'Sigla']);
                const keyIds = findKeyFuzzy(row, ['Nº IDs Serviço Ativos', 'IDs Serviço', 'Serviço Ativos']);
                const keyEquipeFim = findKeyFuzzy(row, ['Equipe Data Fim']);

                const equipeFimValue = normalizeString(row[keyEquipeFim]);
                const refVal = String(row[keyRef] || "N/A");
                const agValue = normalizeString(row[keyAg]);
                const tagValueRaw = String(row[keyTag] || "");
                const tagValue = normalizeString(tagValueRaw);
                const areaValue = normalizeString(row[keyArea]);
                
                let dataInicioStr = "-";
                if (keyDataInicio && row[keyDataInicio]) {
                     const val = row[keyDataInicio];
                     let d;
                     if (typeof val === 'number') {
                         d = new Date(Math.round((val - 25569) * 86400 * 1000));
                     } else {
                         const p = String(val).split(' ')[0].split(/[-/]/);
                         if (p.length === 3) {
                             d = p[0].length === 4 ? new Date(p[0], p[1]-1, p[2]) : new Date(p[2], p[1]-1, p[0]);
                         } else {
                             d = new Date(val);
                         }
                     }
                     if (d && !isNaN(d.getTime())) {
                         dataInicioStr = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
                     }
                }
                const dataFimStr = row._filterDate || "-";

                // Lógica de Contagem de Tickets (Total, Agregados, Agregadores)
                // REGRA: Contabilizar apenas se "Histórico Comentários" conter "PLANTA EXTERNA"
                // OU se houver ações dos usuários especificados
                const histContent = String(row[keyHist] || "").toUpperCase();
                const hasPlantaExterna = histContent.includes("PLANTA EXTERNA");
                const hasTargetUser = TARGET_USERS_FOR_COUNT.some(u => histContent.includes(u));
                
                const causaValue = normalizeString(row[keyCausa]) || 'N/A';
                const isExcluded = EXCLUDED_CAUSES.some(ex => causaValue.includes(ex));
                const isPlantaInternaN2 = equipeFimValue.includes("PLANTA INTERNA N2");
                const isEsCity = CIDADES_ES_ALVO.some(c => areaValue.includes(normalizeString(c)));
                const isValidTicket = (hasPlantaExterna || hasTargetUser) && !isExcluded && !isPlantaInternaN2 && !isEsCity;

                if (isValidTicket) {
                    s.totalSet.add(refVal);
                    kpiData.total.push(row);
                    if (!cmSets[causaValue]) cmSets[causaValue] = new Set();
                    cmSets[causaValue].add(refVal);
                }

                if (agValue === 'AGREGADO') {
                    if (isValidTicket) {
                        s.agrSet.add(refVal);
                        kpiData.agregado.push(row);
                    }
                    return; // Exclui do processamento posterior
                }

                if (!agValue || agValue === "NULL" || agValue === 'AGREGADOR' || tagValue.includes('B2B') || tagValue.includes('AGG')) {
                    if (isValidTicket) {
                        s.agrsSet.add(refVal);
                        kpiData.agregadores.push(row);
                    }
                }
                // const areaValue = normalizeString(row[keyArea]);
                let ufValue = String(row[keyUF] || "N/A");

                if (ufValue === "N/A" || !ufValue.trim()) {
                    const ac = normalizeString(areaValue);
                    if (UF_AL.some(c => ac.includes(normalizeString(c)))) ufValue = "AL";
                    else if (UF_AM.some(c => ac.includes(normalizeString(c)))) ufValue = "AM";
                    else if (UF_AP.some(c => ac.includes(normalizeString(c)))) ufValue = "AP";
                    else if (UF_BA.some(c => ac.includes(normalizeString(c)))) ufValue = "BA";
                    else if (UF_CE.some(c => ac.includes(normalizeString(c)))) ufValue = "CE";
                    else if (UF_ES.some(c => ac.includes(normalizeString(c)))) ufValue = "ES";
                    else if (UF_GO.some(c => ac.includes(normalizeString(c)))) ufValue = "GO";
                    else if (UF_MA.some(c => ac.includes(normalizeString(c)))) ufValue = "MA";
                    else if (UF_MG.some(c => ac.includes(normalizeString(c)))) ufValue = "MG";
                    else if (UF_MS.some(c => ac.includes(normalizeString(c)))) ufValue = "MS";
                    else if (UF_MT.some(c => ac.includes(normalizeString(c)))) ufValue = "MT";
                    else if (UF_PA.some(c => ac.includes(normalizeString(c)))) ufValue = "PA";
                    else if (UF_PB.some(c => ac.includes(normalizeString(c)))) ufValue = "PB";
                    else if (UF_PE.some(c => ac.includes(normalizeString(c)))) ufValue = "PE";
                    else if (UF_PI.some(c => ac.includes(normalizeString(c)))) ufValue = "PI";
                    else if (UF_RJ.some(c => ac.includes(normalizeString(c)))) ufValue = "RJ";
                    else if (UF_RN.some(c => ac.includes(normalizeString(c)))) ufValue = "RN";
                    else if (UF_RO.some(c => ac.includes(normalizeString(c)))) ufValue = "RO";
                    else if (UF_RS.some(c => ac.includes(normalizeString(c)))) ufValue = "RS";
                    else if (UF_SC.some(c => ac.includes(normalizeString(c)))) ufValue = "SC";
                    else if (UF_SE.some(c => ac.includes(normalizeString(c)))) ufValue = "SE";
                    else if (UF_TO.some(c => ac.includes(normalizeString(c)))) ufValue = "TO";
                }
                const idsVal = String(row[keyIds] || "0");

                // Processamento de Tags com Regra de Unicidade
                if (tagValue.includes("ADM COPE")) {
                    if(!s.admSet.has(refVal)) { s.admSet.add(refVal); tagDetailsLists['ADM COPE'].push({ ref: refVal, tag: tagValueRaw }); }
                } 
                if (tagValue.includes("DESAGREGADO")) {
                    if(!s.desSet.has(refVal)) { s.desSet.add(refVal); tagDetailsLists['DESAGREGADO'].push({ ref: refVal, tag: tagValueRaw }); }
                }
                if (tagValue.includes("SALA DE CRISE")) { 
                    const isC = /\bC\b/.test(tagValue) || tagValue.includes("CRISE C");
                    const targetSet = isC ? s.scSet : s.snSet;
                    const targetList = isC ? 'SALAS COPE' : 'SALAS NOC';
                    
                    // REGRA 1: Não contabilizar TAGs duplicadas em Salas de Crise
                    if (!targetSet.has(tagValue)) {
                        targetSet.add(tagValue);
                        tagDetailsLists[targetList].push({ ref: refVal, tag: tagValueRaw });
                        if (isC) {
                            const isAgg = tagValue.includes("AGG");
                            const isB2b = tagValue.includes("B2B");
                            if (isAgg) s.scAgg++;
                            if (isB2b) s.scB2b++;
                            if (!isAgg && !isB2b) s.scPon++;
                        }
                    }
                }

                const esc = CIDADES_ES_ALVO.find(x => areaValue.includes(normalizeString(x)));
                if (esc && agValue !== 'AGREGADO' && !equipeFimValue.includes("PLANTA INTERNA N2") && !causaValue.includes("TTK DUPLICADO") && !causaValue.includes("FALHA OPERADORA") && !causaValue.includes("ENDERECO NAO COBERTO") && !causaValue.includes("ALIVIO FISICO")) { s.es++; s.esC[esc] = (s.esC[esc] || 0) + 1; esm[causaValue] = (esm[causaValue] || 0) + 1; volDataES.push(row); }

                const histTxt = String(row[keyHist] || "");
                if (histTxt) {
                    const blocks = histTxt.split(/\n\s*\n/).filter(b => b.trim() !== "");
                    blocks.forEach(block => {
                        const bUpper = normalizeString(block);
                        const cleanBlockText = bUpper.replace(/\s+/g, ' ').trim();
                        const analystInBlock = ANALISTAS_ALVO.find(nome => bUpper.includes(normalizeString(nome)));
                        let messageOnly = bUpper.replace(/\s+/g, ' ').trim();
                        if (analystInBlock) {
                             messageOnly = cleanBlockText.replace(normalizeString(analystInBlock), "").replace(/\d{2}-\d{2}-\d{4}\s\d{2}:\d{2}:\d{2}/, "").replace(/PLANTA EXTERNA\//, "").trim();
                        }
                        const isJustDateTreatment = /^SERA TRATADO DIA \d{2}[/-]\d{2}([/-]\d{2,4})?\.?$/.test(messageOnly);
                        const isExcluded = bUpper.includes("PASSAGEM AUTOMATICA") || bUpper.includes("DISPONIBILIDADE DE EQUIPE") || bUpper.includes("PERCORRER ROTA") || bUpper.includes("PERCORRENDO ROTA") || isJustDateTreatment;
                        const hasInc = includeKeywords.some(kw => bUpper.includes(kw));

                        if (!isExcluded && hasInc && analystInBlock) {
                            let detectedCausa = "OUTRAS PENDÊNCIAS";
                            for (let cat of categoryMapping) { if (cat.kw.some(k => bUpper.includes(normalizeString(k)))) { detectedCausa = cat.id; break; } }
                            causasPendenciaMap[detectedCausa] = (causasPendenciaMap[detectedCausa] || 0) + 1;
                            if (!currentCausaPendenciaDetails[detectedCausa]) currentCausaPendenciaDetails[detectedCausa] = [];
                            currentCausaPendenciaDetails[detectedCausa].push({ ref: refVal, area: areaValue, msg: block.trim() });
                            analistasPendenciaMap[analystInBlock] = (analistasPendenciaMap[analystInBlock] || 0) + 1;
                            if (!currentAnalistaPendenciaDetails[analystInBlock]) currentAnalistaPendenciaDetails[analystInBlock] = [];
                            currentAnalistaPendenciaDetails[analystInBlock].push({ ref: refVal, area: areaValue, msg: block.trim() });
                            
                            let coord = "-";
                            const areaCheck = normalizeString(areaValue);
                            if (CIDADES_ALCIDES.some(c => areaCheck.includes(normalizeString(c)))) coord = "ALCIDES PEREIRA";
                            else if (CIDADES_ANDERSON.some(c => areaCheck.includes(normalizeString(c)))) coord = "ANDERSON LEITE";
                            else if (CIDADES_CARLOS.some(c => areaCheck.includes(normalizeString(c)))) coord = "CARLOS PEDRUZI";
                            else if (CIDADES_JOSE.some(c => areaCheck.includes(normalizeString(c)))) coord = "JOSÉ DO PRADO";
                            else if (CIDADES_THIAGO.some(c => areaCheck.includes(normalizeString(c)))) coord = "THIAGO SILVEIRA";
                            
                            let eps = "-";
                            if (EPS_R2.some(c => areaCheck.includes(normalizeString(c)))) eps = "R2";
                            else if (EPS_ONDACOM.some(c => areaCheck.includes(normalizeString(c)))) eps = "ONDACOM";
                            else if (EPS_RADIANTE_RJ.some(c => areaCheck.includes(normalizeString(c)))) eps = "RADIANTE RJ";
                            else if (EPS_RADIANTE_RS.some(c => areaCheck.includes(normalizeString(c)))) eps = "RADIANTE RS";
                            else if (EPS_RADIANTE_MG.some(c => areaCheck.includes(normalizeString(c)))) eps = "RADIANTE MG";
                            else if (EPS_FIBRASIL.some(c => areaCheck.includes(normalizeString(c)))) eps = "FIBRASIL";
                            else if (EPS_TLP.some(c => areaCheck.includes(normalizeString(c)))) eps = "TLP";
                            else if (EPS_TECNOMULTI.some(c => areaCheck.includes(normalizeString(c)))) eps = "TECNOMULTI";
                            else if (EPS_ABILITY.some(c => areaCheck.includes(normalizeString(c)))) eps = "ABILITY";
                            else if (EPS_VIRTEX.some(c => areaCheck.includes(normalizeString(c)))) eps = "VIRTEX";

                            masterPendenciasList.push({ ref: refVal, analista: analystInBlock, causa: detectedCausa, uf: ufValue, ids: idsVal, area: areaValue, tag: tagValueRaw, dataInicio: dataInicioStr, dataFim: dataFimStr, msg: block.trim(), coordenador: coord, eps: eps });
                            const dateMatch = block.match(/\d{2}-\d{2}-\d{4}/);
                            if (dateMatch) { const dk = dateMatch[0].replace(/-/g, '/'); dailyTotalsMap[dk] = (dailyTotalsMap[dk] || 0) + 1; }
                        }
                    });
                }
                const dateVal = row[keyData];
                if (dateVal) {
                    let d;
                    if (typeof dateVal === 'number') {
                        d = new Date(Math.round((dateVal - 25569) * 86400 * 1000));
                    } else {
                        const p = String(dateVal).split(' ')[0].split(/[-/]/);
                        if (p.length === 3) {
                            d = p[0].length === 4 ? new Date(p[0], p[1]-1, p[2]) : new Date(p[2], p[1]-1, p[0]);
                        } else {
                            d = new Date(dateVal);
                        }
                    }
                    if (d && !isNaN(d.getTime())) { s.d.push(d); const k = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`; tm[k] = (tm[k] || 0) + 1; }
                }
                let reg = areaValue.replace(/-/g, '').trim();
                if (reg && reg !== '-') rm[reg] = (rm[reg] || 0) + 1;
            });

            const cm = {};
            Object.keys(cmSets).forEach(k => cm[k] = cmSets[k].size);

            // Atualiza contadores finais baseados nos Sets
            s.total = s.totalSet.size;
            s.agr = s.agrSet.size;
            s.agrs = s.agrsSet.size;

            updateVolUI(s, cm, esm, rm, tm);
        }

        function renderPendenciasList() {
            const mode = pendenciasViewMode;
            const container = document.getElementById('main-pendencias-list');
            if(!container) return;

            if (mode === 'turnos') {
                container.classList.add('h-full');
                const shiftStats = {};
                Object.keys(SHIFT_DEFINITIONS).forEach(k => shiftStats[k] = { total: 0, causes: {} });

                masterPendenciasList.forEach(p => {
                    const nameUpper = normalizeString(p.analista);
                    for (const [shift, def] of Object.entries(SHIFT_DEFINITIONS)) {
                        if (def.members.some(m => nameUpper.includes(normalizeString(m)))) {
                            shiftStats[shift].total++;
                            const c = p.causa;
                            shiftStats[shift].causes[c] = (shiftStats[shift].causes[c] || 0) + 1;
                            break; 
                        }
                    }
                });

                container.innerHTML = `<div class="grid grid-cols-3 gap-2 h-full">
                    ${Object.entries(SHIFT_DEFINITIONS).map(([shift, def]) => {
                        const stats = shiftStats[shift];
                        const topCauses = Object.entries(stats.causes).sort((a,b) => b[1]-a[1]).slice(0,5);
                        return `<div class="bg-white border border-slate-200 rounded-lg p-3 shadow-sm hover:border-blue-500 transition-colors cursor-default flex flex-col justify-between flex-1">
                            <div class="flex flex-col items-center border-b border-slate-100 pb-2">
                                <div class="bg-slate-800 text-white px-8 py-1.5 rounded-lg shadow-md mb-1">
                                    <h4 class="text-2xl font-black leading-none">${shift}</h4>
                                </div>
                                <p class="text-[12px] font-bold text-slate-500 uppercase">${def.time}</p>
                            </div>
                            <div class="space-y-1 flex-1 flex flex-col justify-center py-2">
                                ${topCauses.map(([c,v]) => `<div class="flex justify-between items-center text-[10px] font-bold text-slate-500"><span class="truncate mr-2" title="${c}">${c}</span><span class="bg-slate-100 px-1.5 rounded text-slate-700">${v}</span></div>`).join('')}
                            </div>
                            <div class="flex justify-center items-center border-t border-slate-100 pt-2">
                                <div class="bg-red-50 rounded px-4 py-1"><span class="text-3xl font-black text-red-700">${stats.total}</span></div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
                return;
            }
            container.classList.remove('h-full');

            const dataMap = mode === 'causa' ? causasPendenciaMap : analistasPendenciaMap;
            const sorted = Object.entries(dataMap).sort((a,b) => b[1] - a[1]);
            const maxVal = Math.max(...Object.values(dataMap), 1);
            const totalSum = Object.values(dataMap).reduce((a, b) => a + b, 0);
            container.innerHTML = sorted.map(([k,v]) => {
                const percent = totalSum > 0 ? ((v / totalSum) * 100).toFixed(1) + '%' : '0%';
                return `<div class="analista-item flex items-center gap-3 p-2 border-l-4 border-red-100 hover:border-red-500 mb-1 transition-all rounded-r-lg group" ondblclick="openDetailsModal('${k}')">
                <div class="min-w-[34px] bg-red-900 text-white text-center py-0.5 rounded text-[10px] font-black">${v}</div>
                <div class="flex-1"><div class="flex justify-between items-end mb-1 font-black"><p class="text-[9px] font-black text-red-800 uppercase truncate">${k}</p><span class="detalhes-badge uppercase !bg-red-200 !text-red-800 group-hover:!bg-red-600 group-hover:!text-white">${percent}</span></div>
                <div class="w-full bg-slate-100 h-1 rounded-full"><div class="bg-red-600 h-full rounded" style="width:${(v/maxVal*100).toFixed(1)}%"></div></div></div></div>`;
            }).join('');
        }

        function updateVolUI(s, cm, esm, rm, tm) {
            document.getElementById('kpi-total').innerText = s.agrs;
            document.getElementById('kpi-es').innerText = s.es;
            document.getElementById('stat-agregadores-val').innerText = s.agrs;
            document.getElementById('stat-agregado-val').innerText = s.agr;
            document.getElementById('tag-adm-val').innerText = s.admSet.size;
            document.getElementById('tag-desag-val').innerText = s.desSet.size;
            document.getElementById('tag-sala-cope-val').innerText = s.scSet.size;
            document.getElementById('tag-sala-noc-val').innerText = s.snSet.size;
            document.getElementById('sc-agg-val').innerText = s.scAgg;
            document.getElementById('sc-b2b-val').innerText = s.scB2b;
            document.getElementById('sc-pon-val').innerText = s.scPon;
            document.getElementById('total-pendencias-counter').innerText = masterPendenciasList.length;
            
            if(s.d.length) {
                const minDate = new Date(Math.min(...s.d)).toLocaleDateString('pt-BR');
                const maxDate = new Date(Math.max(...s.d)).toLocaleDateString('pt-BR');
                const rangeText = minDate === maxDate ? minDate : `${minDate} a ${maxDate}`;
                const filterSelect = document.getElementById('dateFilter');
                if (filterSelect) {
                    const allOpt = filterSelect.querySelector('option[value="all"]');
                    if (allOpt) allOpt.textContent = `Geral (${rangeText})`;
                }
            }

            const dailyContainer = document.getElementById('daily-totals-container');
            if(dailyContainer) dailyContainer.innerHTML = Object.entries(dailyTotalsMap).sort().map(([day, total]) => `<div class="daily-item font-black uppercase">DATA ${day}: ${total}</div>`).join('');
            
            renderPendenciasList();
            
            const renderDefault = (id, arr, tot) => {
                const container = document.getElementById(id);
                if(!container) return;
                const isCausa = id === 'causas-list-container';
                container.innerHTML = arr.map(([k,v]) => `<div ${isCausa ? `ondblclick="openCausaModal('${k.replace(/'/g, "\\'")}')"` : ''} class="flex items-center gap-3 p-1 border-l-4 border-slate-100 hover:border-orange-500 mb-1 transition-all ${isCausa ? 'cursor-pointer hover:bg-slate-50' : ''}"><div class="min-w-[34px] bg-slate-900 text-white text-center py-0.5 rounded text-[10px] font-black">${v}</div><div class="flex-1"><p class="text-[9px] font-black text-slate-600 uppercase mb-1 truncate">${k}</p><div class="w-full bg-slate-100 h-1 rounded-full"><div class="bg-orange-500 h-full rounded" style="width:${tot > 0 ? (v/tot*100).toFixed(1) : 0}%"></div></div></div></div>`).join('');
            };
            renderDefault('causas-list-container', Object.entries(cm).sort((a,b)=>b[1]-a[1]).slice(0, isAdminMode ? undefined : 6), s.total);
            renderDefault('causas-es-list-container', Object.entries(esm).sort((a,b)=>b[1]-a[1]).slice(0, isAdminMode ? undefined : 3), s.es);
            renderDefault('top-cities-es', Object.entries(s.esC).sort((a,b)=>b[1]-a[1]).slice(0, isAdminMode ? undefined : 3), s.es);
            updateCharts(rm, tm, dailyTotalsMap);
            renderPendenciasChart();
        }

        function renderPendenciasChart() {
            const chartPend = document.getElementById('pendenciasProgressChart');
            if (!chartPend) return;
            
            if (charts.pendProgress) {
                charts.pendProgress.destroy();
                delete charts.pendProgress;
            }

            const startVal = document.getElementById('pendStart').value;
            const endVal = document.getElementById('pendEnd').value;
            
            let filteredData = Object.entries(dailyTotalsMap);
            
            if (startVal || endVal) {
                const startDate = startVal ? new Date(startVal) : null;
                const endDate = endVal ? new Date(endVal) : null;
                
                filteredData = filteredData.filter(([dateStr, val]) => {
                    const [d, m, y] = dateStr.split('/').map(Number);
                    const curr = new Date(y, m-1, d);
                    if (startDate && curr < startDate) return false;
                    if (endDate && curr > endDate) return false;
                    return true;
                });
            }
            
            filteredData.sort((a, b) => {
                const [d1, m1, y1] = a[0].split('/').map(Number);
                const [d2, m2, y2] = b[0].split('/').map(Number);
                return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2);
            });

            const ctxPend = chartPend.getContext('2d');
            const opt = { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { font: { size: 9, weight: '700' } } }, x: { ticks: { font: { size: 9, weight: '700' } } } } };
            
            charts.pendProgress = new Chart(ctxPend, { type: 'line', data: { labels: filteredData.map(x=>x[0].substring(0, 5)), datasets: [{ data: filteredData.map(x=>x[1]), borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', fill: true, tension: 0.4 }] }, options: opt });
        }

        function updateCharts(rm, tm, dailyPendencias) {
            const chartReg = document.getElementById('regioesChart'), chartTim = document.getElementById('timelineChart');
            if (chartReg && chartTim) {
                const ctxReg = chartReg.getContext('2d'), ctxTim = chartTim.getContext('2d');
                if(charts.reg) charts.reg.destroy(); if(charts.tim) charts.tim.destroy();
                const rData = Object.entries(rm).sort((a,b)=>b[1]-a[1]).slice(0,5), tData = Object.entries(tm).sort((a,b)=>{ const [d1,m1]=a[0].split('/').map(Number), [d2,m2]=b[0].split('/').map(Number); return (m1*100+d1)-(m2*100+d2); });
                const opt = { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { font: { size: 9, weight: '700' } } }, x: { ticks: { font: { size: 9, weight: '700' } } } } };
                charts.reg = new Chart(ctxReg, { type: 'bar', data: { labels: rData.map(x=>x[0]), datasets: [{ data: rData.map(x=>x[1]), backgroundColor: '#1e293b', barThickness: 12 }] }, options: { ...opt, indexAxis: 'y' } });
                charts.tim = new Chart(ctxTim, { type: 'line', data: { labels: tData.map(x=>x[0]), datasets: [{ data: tData.map(x=>x[1]), borderColor: '#F37021', backgroundColor: 'rgba(243, 112, 33, 0.05)', fill: true, tension: 0.4 }] }, options: opt });
            }
        }

        function downloadExcelES() {
            if (volDataES.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(volDataES), wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ES"); XLSX.writeFile(wb, "PRODUCAO_ES.xlsx");
        }

        async function downloadPDF() {
            const el = document.getElementById('dashboard-content');
            const originalStyle = el.getAttribute('style') || "";
            
            // Ajuste otimizado para A4 Paisagem (297mm x 210mm) com margens de 5mm
            el.style.width = '1085px'; 
            el.style.maxWidth = 'none'; 
            el.classList.add('pdf-export-mode');
            
            const opt = { 
                margin: [5, 5, 5, 5], 
                filename: 'Relatorio_Volumetria.pdf', 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true, letterRendering: true, scrollY: 0 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            try { 
                await html2pdf().set(opt).from(el).save(); 
            } finally { 
                el.setAttribute('style', originalStyle); 
                el.classList.remove('pdf-export-mode'); 
            }
        }

        // --- LÓGICA LIGAÇÕES COPE ---
        document.getElementById('fileInputLigacoesCope').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.SheetNames[0];
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { defval: "" });
                processLigacoesCope(jsonData);
            };
            reader.readAsArrayBuffer(file);
        });

        function processLigacoesCope(data) {
            let totalCalls = 0;
            let totalSeconds = 0;
            let totalRejected = 0;
            let totalSuccess = 0;
            const daysSet = new Set();
            const collabMap = {};
            const dailyMap = {};
            let minDate = null;
            let maxDate = null;
            const dailyRows = {}; // Armazena as linhas por data para o modal

            const groups = {
                "T1 - 06H15 ÁS 15H15": ["TAMIRIS", "BRUNO", "JULIANA", "JOSEYLSON"],
                "T2 - 15H00 ÁS 23H43": ["ELVIS", "RANDU", "LUAN", "JEFFERSON"],
                "T3 - 23H30 ÁS 06h30": ["CAIO", "EDMAR", "GABRIEL"]
            };
            const groupCounts = { 
                "T1 - 06H15 ÁS 15H15": { total: 0, rejected: 0, success: 0 }, 
                "T2 - 15H00 ÁS 23H43": { total: 0, rejected: 0, success: 0 }, 
                "T3 - 23H30 ÁS 06h30": { total: 0, rejected: 0, success: 0 } 
            };
            data.forEach(row => {
                const keyCollab = findKeyFuzzy(row, ['Chamada de', 'Caller', 'Origem', 'From', 'Colaborador']);
                
                // Prioridade para encontrar a coluna de Duração (Duração da chamada)
                let keyDur = null;
                const durKeywords = ['Duração da chamada', 'Duração', 'Duration', 'Time']; // Removido 'Tempo' para evitar conflito com Data se solicitado
                const rowKeys = Object.keys(row);
                for (const kw of durKeywords) {
                    const found = rowKeys.find(k => normalizeString(k).includes(normalizeString(kw)));
                    if (found) { keyDur = found; break; }
                }

                const keyDate = findKeyFuzzy(row, ['Tempo', 'Hora de início', 'Start time', 'Início', 'Date', 'Data']);

                if (!keyCollab && !keyDur && !keyDate) return;

                // Lógica de Status (Rejeitadas vs Sucesso)
                const keyStatus = findKeyFuzzy(row, ['Estado', 'Status', 'Disposition', 'State']);
                let isRejected = false;
                let isSuccess = false;

                if (keyStatus) {
                    const status = String(row[keyStatus]).toUpperCase().trim();
                    
                    if (status === 'BUSY' || status === 'VOICEMAIL') return;

                    if (status === 'NO ANSWER') {
                        totalRejected++;
                        isRejected = true;
                    } else if (status === 'ANSWER' || status === 'ANSWERED') {
                        totalSuccess++;
                        isSuccess = true;
                    }
                }

                totalCalls++;

                const collab = row[keyCollab] ? String(row[keyCollab]).trim().toUpperCase() : "NÃO IDENTIFICADO";
                collabMap[collab] = (collabMap[collab] || 0) + 1;

                for (const [gName, members] of Object.entries(groups)) {
                    if (members.some(m => collab.includes(m))) {
                        groupCounts[gName].total++;
                        if (isRejected) groupCounts[gName].rejected++;
                        if (isSuccess) groupCounts[gName].success++;
                        break;
                    }
                }

                const durRaw = row[keyDur];
                let seconds = 0;
                if (typeof durRaw === 'number') {
                    // Soma direta dos segundos da coluna numérica
                    seconds = Math.round(durRaw);
                } else if (typeof durRaw === 'string') {
                    if (!isNaN(durRaw) && !durRaw.includes(':') && durRaw.trim() !== '') {
                        seconds = Math.round(parseFloat(durRaw));
                    } else {
                        const parts = durRaw.split(':');
                        if (parts.length === 3) seconds = (+parts[0]) * 3600 + (+parts[1]) * 60 + (+parts[2]);
                        else if (parts.length === 2) seconds = (+parts[0]) * 60 + (+parts[1]);
                    }
                }
                totalSeconds += seconds;

                const dateRaw = row[keyDate];
                let dateStr = "N/A";
                let dateObjForSort = null;

                if (dateRaw) {
                    if (typeof dateRaw === 'number') {
                        // Correção para datas Excel (Serial Number) evitando deslocamento de fuso horário
                        const dateObj = new Date(Math.round((dateRaw - 25569) * 86400 * 1000));
                        const d = new Date(dateObj.getUTCFullYear(), dateObj.getUTCMonth(), dateObj.getUTCDate());
                        dateStr = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
                        dateObjForSort = d;
                    } else {
                        // Tratamento robusto para string: Traz o valor EXATO da coluna (removendo hora se houver)
                        const str = String(dateRaw).trim();
                        dateStr = str.split(/\s+/)[0]; // Pega a primeira parte (data) ignorando hora
                        
                        // Tenta parsear APENAS para ordenação, sem alterar a string de exibição
                        let match = str.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
                        if (match) {
                            // ISO YYYY-MM-DD
                            dateObjForSort = new Date(parseInt(match[1]), parseInt(match[2])-1, parseInt(match[3]));
                        } else {
                            // Tenta DD/MM/AAAA ou MM/DD/AAAA
                            match = str.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
                            if (match) {
                                const p1 = parseInt(match[1], 10);
                                const p2 = parseInt(match[2], 10);
                                let y = parseInt(match[3], 10);
                                if (y < 100) y += 2000;
                                
                                // Regra de verificação:
                                // Se p2 > 12, p2 é DIA. Logo formato é MM/DD/AAAA (US).
                                // Se p1 > 12, p1 é DIA. Logo formato é DD/MM/AAAA (BR).
                                // Se ambos <= 12, assume BR (DD/MM/AAAA) por padrão.
                                if (p2 > 12) {
                                    dateObjForSort = new Date(y, p1 - 1, p2);
                                } else {
                                    dateObjForSort = new Date(y, p2 - 1, p1);
                                }
                            } else {
                                const tryD = new Date(str);
                                if (!isNaN(tryD.getTime())) dateObjForSort = tryD;
                            }
                        }
                    }
                }

                if (dateStr !== "N/A") {
                    // Normaliza para DD/MM/AAAA se tivermos um objeto de data válido
                    if (dateObjForSort) {
                        dateStr = `${String(dateObjForSort.getDate()).padStart(2,'0')}/${String(dateObjForSort.getMonth()+1).padStart(2,'0')}/${dateObjForSort.getFullYear()}`;
                        // Atualiza a linha para exibição correta no modal
                        row[keyDate] = dateStr;
                    }

                    daysSet.add(dateStr);
                    dailyMap[dateStr] = (dailyMap[dateStr] || 0) + 1;
                    if (!dailyRows[dateStr]) dailyRows[dateStr] = [];
                    dailyRows[dateStr].push(row);
                    
                    // Armazena objeto de data para ordenação no mapa (hack simples)
                    if (dateObjForSort) dailyMap[dateStr + "_SORT"] = dateObjForSort;
                }
            });

            // Salva dados globais para o modal
            window.ligacoesCopeData = dailyRows;

            document.getElementById('total-ligacoes').innerText = totalCalls;
            document.getElementById('total-rejeitadas').innerText = totalRejected;
            document.getElementById('total-sucesso').innerText = totalSuccess;
            const h = Math.floor(totalSeconds / 3600), m = Math.floor((totalSeconds % 3600) / 60), s = Math.floor(totalSeconds % 60);
            document.getElementById('total-tempo-ligacoes').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            
            // 1. Cálculo de Dias Analisados (Total de dias únicos identificados)
            document.getElementById('total-dias-ligacoes').innerText = daysSet.size;

            document.getElementById('lista-colaboradores-ligacoes').innerHTML = Object.entries(groupCounts).map(([k,v]) => {
                const members = groups[k].join(', ');
                const [turma, horario] = k.split(' - ');
                return `<div class="flex-1 flex flex-col items-center justify-center bg-slate-50 border border-blue-100 rounded-lg p-2 hover:border-blue-500 transition-all" title="${members}">
                    <div class="w-full bg-blue-900 text-white text-center py-1.5 rounded text-[12px] font-black mb-2 shadow-sm cursor-default">${turma}</div>
                    <p class="text-[9px] font-black text-slate-500 uppercase text-center leading-tight mb-2">${horario}</p>
                    <p class="text-3xl font-black text-blue-800 mb-1">${v.total}</p>
                    <div class="flex gap-3 w-full justify-center border-t border-slate-200 pt-1">
                        <div class="text-center"><p class="text-[8px] font-black text-green-600 uppercase">SUC</p><p class="text-xs font-black text-green-500">${v.success}</p></div>
                        <div class="text-center"><p class="text-[8px] font-black text-red-600 uppercase">REJ</p><p class="text-xs font-black text-red-400">${v.rejected}</p></div>
                    </div>
                </div>`;
            }).join('');

            // 2. Progressão Diária (Apenas dias identificados)
            let sortedDays = [];
            // Filtra chaves de ordenação e ordena
            const keys = Object.keys(dailyMap).filter(k => !k.endsWith("_SORT"));
            sortedDays = keys.sort((a,b) => {
                const dA = dailyMap[a + "_SORT"] || new Date(0);
                const dB = dailyMap[b + "_SORT"] || new Date(0);
                return dA - dB;
            }).map(k => [k, dailyMap[k]]);
            
            if (charts.ligacoesCope) charts.ligacoesCope.destroy();
            const ligacoesCtx = document.getElementById('ligacoesCopeChart').getContext('2d');
            charts.ligacoesCope = new Chart(ligacoesCtx, {
                type: 'line',
                data: {
                    labels: sortedDays.map(d => d[0]),
                    datasets: [{
                        label: 'Ligações',
                        data: sortedDays.map(d => d[1]),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 9, weight: '600' }, precision: 0 } },
                        x: { ticks: { font: { size: 9, weight: '600' } } }
                    },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const index = activeEls[0].index;
                            const dateKey = sortedDays[index][0];
                            openLigacoesDiaModal(dateKey);
                        }
                    }
                }
            });
            
            document.getElementById('ligacoes-content').classList.remove('hidden');
            document.getElementById('ligacoes-placeholder').classList.add('hidden');
        }

        // Função para abrir modal de Ligações
        window.openLigacoesDiaModal = function(dateKey) {
            const rows = window.ligacoesCopeData ? window.ligacoesCopeData[dateKey] : [];
            if (!rows || rows.length === 0) return;

            document.getElementById('modalAnalista').innerText = `LIGAÇÕES: ${dateKey}`;
            document.getElementById('modalSubTitle').innerText = `${rows.length} registros encontrados`;
            
            const btnExport = document.getElementById('btnExtrairModal');
            btnExport.classList.remove('hidden');
            btnExport.onclick = function() {
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Ligacoes_Dia");
                XLSX.writeFile(wb, `LIGACOES_${dateKey.replace(/[^a-z0-9]/gi, '-')}.xlsx`);
            };

            const content = document.getElementById('modalContent');
            const headers = Object.keys(rows[0]);
            const headerHtml = headers.map(h => `<th class="p-3 whitespace-nowrap">${h}</th>`).join('');
            const bodyHtml = rows.slice(0, 100).map(r => `<tr>${headers.map(h => `<td class="p-3 whitespace-nowrap border-b border-slate-100">${r[h] || ''}</td>`).join('')}</tr>`).join('');

            content.innerHTML = `<div class="overflow-auto max-h-[60vh]"><table class="w-full text-left border-collapse text-[10px]"><thead><tr class="bg-slate-900 text-white font-black sticky top-0">${headerHtml}</tr></thead><tbody class="font-medium text-slate-600">${bodyHtml}</tbody></table></div>${rows.length > 100 ? '<p class="text-xs text-center mt-2 text-slate-400 font-bold uppercase">Exibindo os primeiros 100 registros.</p>' : ''}`;
            
            document.getElementById('detailsModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalBox').classList.add('scale-100'), 10);
        }

        // --- CARREGAMENTO AUTOMÁTICO DO ARQUIVO PADRÃO (VOLUMETRIA) ---
        async function loadDefaultFiles() {
            if (defaultFilesLoaded) return;
            defaultFilesLoaded = true;

            try {
                const filename = 'Volumetria_Janeiro 2026.xls';
                const response = await fetch(filename);
                if (response.ok) {
                    const data = await response.arrayBuffer();
                    const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rowsRaw = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Lógica de detecção de cabeçalho (mesma do input manual)
                    let hIdx = rowsRaw.findIndex(r => r && r.some(c => normalizeString(c).includes('CAUSA')));
                    if (hIdx === -1 && rowsRaw.length > 1 && (!rowsRaw[0] || rowsRaw[0].length === 0)) hIdx = 1;
                    
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { range: hIdx === -1 ? 0 : hIdx });
                    const validData = jsonData.filter(r => Object.values(r).some(v => v !== null && v !== ""));
                    
                    if (validData.length > 0) {
                        processVolData(validData);
                        console.log(`Volumetria: Arquivo padrão '${filename}' carregado com sucesso.`);
                    }
                }
            } catch (e) {
                console.log("Volumetria: Nenhum arquivo padrão carregado ou erro na leitura.", e);
            }

            // --- CARREGAMENTO AUTOMÁTICO DO ARQUIVO PADRÃO (LIGAÇÕES) ---
            try {
                const filenameLig = 'Ligações_Janeiro 2026.xlsx';
                const responseLig = await fetch(filenameLig);
                if (responseLig.ok) {
                    const dataLig = await responseLig.arrayBuffer();
                    const workbookLig = XLSX.read(new Uint8Array(dataLig), { type: 'array' });
                    const firstSheetLig = workbookLig.Sheets[workbookLig.SheetNames[0]];
                    const jsonDataLig = XLSX.utils.sheet_to_json(firstSheetLig, { defval: "" });
                    processLigacoesCope(jsonDataLig);
                    console.log(`Ligações: Arquivo padrão '${filenameLig}' carregado com sucesso.`);
                }
            } catch (e) {
                console.log("Ligações: Nenhum arquivo padrão carregado ou erro na leitura.", e);
            }
        }
    </script>
</body>
</html> 
            }
        }
    </script>
</body>
</html> 
